<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly View - Wheeler</title>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/styles.css">
    <style>
        .daterangepicker {
            background: #2d2d2d;
            border: 1px solid #575757;
        }
        .daterangepicker .calendar-table {
            background: #2d2d2d;
            border: 1px solid #575757;
        }
        .daterangepicker .calendar-table .table-condensed {
            display: none;
        }
        .daterangepicker .month-picker {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding: 20px;
        }
        .daterangepicker .month-picker .month-cell {
            padding: 12px;
            text-align: center;
            cursor: pointer;
            background: #1a1a1a;
            border: 1px solid #575757;
            border-radius: 4px;
            color: #e0e0e0;
        }
        .daterangepicker .month-picker .month-cell:hover {
            background-color: #404040;
        }
        .daterangepicker .month-picker .month-cell.active {
            background-color: #27ae60 !important;
        }
        .daterangepicker td, .daterangepicker th {
            color: #e0e0e0;
        }
        .daterangepicker td.available:hover {
            background-color: #404040;
        }
        .daterangepicker td.active {
            background-color: #27ae60 !important;
        }
        .daterangepicker .ranges li:hover {
            background-color: #404040;
        }
        .daterangepicker .ranges li.active {
            background-color: #27ae60;
        }
        .daterangepicker select {
            background: #1a1a1a;
            color: #e0e0e0;
            border: 1px solid #575757;
        }
        .daterangepicker .drp-calendar {
            max-width: 300px;
        }
        .daterangepicker .calendar-table thead,
        .daterangepicker .calendar-table tbody {
            display: none;
        }
    </style>
</head>
<body class="monthly-page">
    <div class="app-container">
        <!-- Sidebar -->
        {{template "_navigation.html" .}}
        
        <!-- Main Content -->
        <div class="main-content">
            
            <!-- Aggregated Totals Panel -->
            <div class="content-section" style="margin-bottom: 20px;">
                <div style="background: #2d2d2d; padding: 15px; border-radius: 8px; border: 1px solid #404040; display: flex; align-items: center; justify-content: space-between;">
                    <!-- Month Range Picker (Left) -->
                    <div style="display: flex; align-items: center; gap: 10px; font-size: 14px;">
                        <input type="text" id="monthRange" readonly value="" style="padding: 8px 12px; background: #1a1a1a; border: 1px solid #575757; border-radius: 4px; color: #e0e0e0; font-size: 14px; cursor: pointer; width: 200px;">
                    </div>
                    
                    <!-- Totals (Center) -->
                    <div style="text-align: center; font-size: 20px;">
                        <span style="color: #a0a0a0;">Total:</span> <span id="grandTotal" style="color: #27ae60;">$0</span>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        <span style="color: #a0a0a0;">Puts:</span> <span id="totalPuts" style="color: #27ae60;">$0</span>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        <span style="color: #a0a0a0;">Calls:</span> <span id="totalCalls" style="color: #27ae60;">$0</span>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        <span style="color: #a0a0a0;">Capital Gains:</span> <span id="totalCapGains" style="color: #27ae60;">$0</span>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        <span style="color: #a0a0a0;">Dividends:</span> <span id="totalDividends" style="color: #27ae60;">$0</span>
                    </div>
                    
                    <!-- Placeholder for balance (Right) -->
                    <div style="width: 200px;"></div>
                </div>
            </div>
            
            <!-- Gains Chart with Monthly Bars and Cumulative Line -->
            <div class="content-section" style="margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div class="section-title">Gains Over Time</div>
                </div>
                <div style="display: flex; gap: 20px; align-items: stretch;">
                    <!-- Cumulative Income Pie Chart (25% width) -->
                    <div style="flex: 0 0 25%; background: #2d2d2d; padding: 15px; border-radius: 8px; border: 1px solid #404040;">
                        <h3 style="color: #e0e0e0; margin: 0 0 10px 0; font-size: 16px; text-align: center;">Cumulative Income</h3>
                        <div style="height: 300px; display: flex; align-items: center; justify-content: center;">
                            <canvas id="cumulativeIncomePieChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Gains Over Time Bar Chart (75% width) -->
                    <div style="flex: 0 0 75%; background: #2d2d2d; padding: 15px; border-radius: 8px; border: 1px solid #404040;">
                        <div style="height: 300px;">
                            <canvas id="cumulativeGainsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Collateral & APR Chart -->
            <div class="content-section" style="margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div class="section-title">Collateral &amp; APR</div>
                </div>
                <div style="background: #2d2d2d; padding: 15px; border-radius: 8px; border: 1px solid #404040;">
                    <div style="height: 300px;">
                        <canvas id="collateralAPRChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- All Charts -->
            <div class="content-section" style="margin-bottom: 30px;">
                        <div class="options-section-row" style="margin-top: 0;">
                        <!-- Puts Section -->
                        <div class="content-section">
                            <div class="section-title">Puts</div>
                            <div class="charts-row">
                                <div class="chart-column">
                                    <h4>By Month</h4>
                                    <div class="chart-container-small">
                                        <canvas id="putsMonthChart"></canvas>
                                    </div>
                                </div>
                                <div class="chart-column">
                                    <h4>By Ticker</h4>
                                    <div class="chart-container-small">
                                        <canvas id="putsTickerChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Calls Section -->
                        <div class="content-section">
                            <div class="section-title">Calls</div>
                            <div class="charts-row">
                                <div class="chart-column">
                                    <h4>By Month</h4>
                                    <div class="chart-container-small">
                                        <canvas id="callsMonthChart"></canvas>
                                    </div>
                                </div>
                                <div class="chart-column">
                                    <h4>By Ticker</h4>
                                    <div class="chart-container-small">
                                        <canvas id="callsTickerChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div>
                        
                        <div class="options-section-row" style="margin-top: 0;">
                        <!-- Capital Gains Section -->
                        <div class="content-section">
                            <div class="section-title">Capital Gains</div>
                            <div class="charts-row">
                                <div class="chart-column">
                                    <h4>By Month</h4>
                                    <div class="chart-container-small">
                                        <canvas id="capGainsMonthChart"></canvas>
                                    </div>
                                </div>
                                <div class="chart-column">
                                    <h4>By Ticker</h4>
                                    <div class="chart-container-small">
                                        <canvas id="capGainsTickerChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Dividends Section -->
                        <div class="content-section">
                            <div class="section-title">Dividends</div>
                            <div class="charts-row">
                                <div class="chart-column">
                                    <h4>By Month</h4>
                                    <div class="chart-container-small">
                                        <canvas id="dividendsMonthChart"></canvas>
                                    </div>
                                </div>
                                <div class="chart-column">
                                    <h4>By Ticker</h4>
                                    <div class="chart-container-small">
                                        <canvas id="dividendsTickerChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div>
            </div>
            
            <!-- Monthly Premiums by Symbol Grouped by Open/Closed -->
            <div class="content-section" style="margin-bottom: 30px;">
                <div class="section-title">Monthly Premiums by Symbol (Open/Closed)</div>
                <div class="chart-container-large">
                    <canvas id="monthlyPremiumsGroupedChart"></canvas>
                </div>
            </div>
            
            <!-- Total Profit by Symbol Table -->
            <div class="content-section">
                <div class="section-title">Total Profit by Symbol</div>
                <div class="table-container-scrollable">
                    <table class="financial-table">
                        <thead>
                            <tr>
                                <th>Ticker</th>
                                <th>Total</th>
                                {{range .TableMonthLabels}}
                                <th>{{.}}</th>
                                {{end}}
                            </tr>
                        </thead>
                        <tbody>
                            {{if .TableData}}
                                {{range $row := .TableData}}
                                <tr>
                                    <td><strong><a href="/symbol/{{$row.Ticker}}" class="symbol-link">{{$row.Ticker}}</a></strong></td>
                                    <td><span>${{printf "%.0f" $row.Total}}</span></td>
                                    {{range $yearMonth := $.TableYearMonths}}
                                        {{$amount := index $row.MonthValues $yearMonth}}
                                        <td>{{if $amount}}{{if ne $amount 0.0}}<span>${{printf "%.0f" $amount}}</span>{{else}}$0{{end}}{{else}}$0{{end}}</td>
                                    {{end}}
                                </tr>
                                {{end}}
                            {{else}}
                                <tr>
                                    <td colspan="{{add (len .TableYearMonths) 2}}" style="text-align: center; color: #a0a0a0;">No profit data available</td>
                                </tr>
                            {{end}}
                        </tbody>
                        <tfoot>
                            {{if .TableTotalsByMonth}}
                            <tr class="table-totals-row">
                                <td><strong>Total</strong></td>
                                <td><span><strong>${{printf "%.0f" .GrandTotal}}</strong></span></td>
                                {{range $yearMonth := .TableYearMonths}}
                                    {{$total := index $.TableTotalsByMonth $yearMonth}}
                                    <td><strong>{{if $total}}{{if ne $total 0.0}}<span>${{printf "%.0f" $total}}</span>{{else}}$0{{end}}{{else}}$0{{end}}</strong></td>
                                {{end}}
                            </tr>
                            {{end}}
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Include Shared Symbol Modal -->
    {{template "_symbol_modal.html"}}

    <script type="module">
        // Import shared utilities
        import { 
            CHART_COLORS, 
            getSymbolColor,
            sortTickerData,
            formatCurrency,
            MONTH_NAMES,
            createDatalabelsConfig,
            FINANCIAL_TOOLTIP
        } from '/static/js/chart-utils.js';
        
        import { applyMonthlyTableFormatting } from '/static/js/table-utils.js';
        
        // Register the datalabels plugin
        Chart.register(ChartDataLabels);
        
        // Track selected symbol for highlighting
        
        // Store all chart instances for updating
        const chartInstances = {
            putsTicker: null,
            callsTicker: null,
            capGainsTicker: null,
            dividendsTicker: null,
            monthlyPremiums: null
        };
        
        // Chart colors, getSymbolColor, and sortTickerData imported from chart-utils.js
        
        // Get actual year-month data from table columns (which have YYYY-MM format)
        const tableYearMonths = [
            {{range $index, $ym := .TableYearMonths}}{{if $index}}, {{end}}"{{$ym}}"{{end}}
        ];
        
        // Use tableYearMonths as the master month list (YYYY-MM format)
        const serverMonthLabels = tableYearMonths;
        
        // Format month labels with year (e.g., "2025-01" -> "Jan 2025") using imported MONTH_NAMES
        const currentMonthLabels = serverMonthLabels.map(ym => {
            const [year, month] = ym.split('-');
            return `${MONTH_NAMES[parseInt(month) - 1]} ${year}`;
        });

        // Puts - By Month Chart (with cumulative line)
        const putsMonthCtx = document.getElementById('putsMonthChart').getContext('2d');
        
        // Build month-indexed data from PutsData.ByMonth
        const putsMonthMap = new Map([
            {{range $index, $data := .PutsData.ByMonth}}{{if $index}}, {{end}}["{{$data.Month}}", {{$data.Amount}}]{{end}}
        ]);
        // Align with master month labels
        const putsMonthData = serverMonthLabels.map(ym => putsMonthMap.get(ym) || 0);
        
        // Calculate cumulative puts data for individual chart
        let putsIndividualCumulativeData = [];
        let putsIndividualRunningTotal = 0;
        for (let i = 0; i < putsMonthData.length; i++) {
            putsIndividualRunningTotal += putsMonthData[i];
            putsIndividualCumulativeData.push(putsIndividualRunningTotal);
        }
        
        new Chart(putsMonthCtx, {
            type: 'bar',
            data: {
                labels: currentMonthLabels,
                datasets: [{
                    type: 'line',
                    label: 'Cumulative Puts',
                    data: putsIndividualCumulativeData,
                    borderColor: '#FFD700',
                    backgroundColor: 'rgba(255, 215, 0, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.2,
                    yAxisID: 'y1',
                    order: 1
                }, {
                    type: 'bar',
                    label: 'Monthly Puts',
                    data: putsMonthData,
                    backgroundColor: function(context) {
                        const value = context.parsed.y;
                        return value < 0 ? 'rgba(214, 39, 40, 0.6)' : 'rgba(31, 119, 180, 0.6)';
                    },
                    borderColor: function(context) {
                        const value = context.parsed.y;
                        return value < 0 ? '#d62728' : '#1f77b4';
                    },
                    borderWidth: 1,
                    yAxisID: 'y',
                    order: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        display: true,
                        position: 'top',
                        labels: {
                            color: '#e0e0e0',
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label || '';
                                return label + ': $' + context.parsed.y.toLocaleString();
                            }
                        }
                    },
                    datalabels: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            color: '#e0e0e0'
                        }
                    },
                    y: {
                        type: 'linear',
                        beginAtZero: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Monthly ($)',
                            color: '#e0e0e0'
                        },
                        ticks: {
                            color: '#e0e0e0',
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    },
                    y1: {
                        type: 'linear',
                        beginAtZero: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Cumulative ($)',
                            color: '#e0e0e0'
                        },
                        ticks: {
                            color: '#e0e0e0',
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                }
            }
        });

        // Get all ticker data for consistent coloring across both charts
        const putsTickerLabelsUnsorted = [
            {{range $index, $data := .PutsData.ByTicker}}{{if $index}}, {{end}}"{{$data.Ticker}}"{{end}}
        ];
        const putsTickerDataUnsorted = [
            {{range $index, $data := .PutsData.ByTicker}}{{if $index}}, {{end}}{{$data.Amount}}{{end}}
        ];
        const callsTickerLabelsUnsorted = [
            {{range $index, $data := .CallsData.ByTicker}}{{if $index}}, {{end}}"{{$data.Ticker}}"{{end}}
        ];
        const callsTickerDataUnsorted = [
            {{range $index, $data := .CallsData.ByTicker}}{{if $index}}, {{end}}{{$data.Amount}}{{end}}
        ];
        
        // Get capital gains and dividends ticker labels
        const capGainsTickerLabelsRaw = [
            {{range $index, $data := .CapGainsData.ByTicker}}{{if $index}}, {{end}}"{{$data.Ticker}}"{{end}}
        ];
        const dividendsTickerLabelsRaw = [
            {{range $index, $data := .DividendsData.ByTicker}}{{if $index}}, {{end}}"{{$data.Ticker}}"{{end}}
        ];
        
        // Create unified symbol list for consistent coloring from ALL data sources
        const allUniqueSymbols = [...new Set([
            ...putsTickerLabelsUnsorted, 
            ...callsTickerLabelsUnsorted,
            ...capGainsTickerLabelsRaw,
            ...dividendsTickerLabelsRaw
        ])].sort();
        
        // Puts - By Ticker Chart
        const putsTickerCtx = document.getElementById('putsTickerChart').getContext('2d');
        
        // Sort puts ticker data alphabetically
        const putsSorted = sortTickerData(putsTickerLabelsUnsorted, putsTickerDataUnsorted);
        const putsTickerLabels = putsSorted.labels;
        const putsTickerData = putsSorted.data;
        
        // Get consistent colors for puts symbols
        const putsColors = putsTickerLabels.map(symbol => getSymbolColor(symbol, allUniqueSymbols));
        
        chartInstances.putsTicker = new Chart(putsTickerCtx, {
            type: 'pie',
            data: {
                labels: putsTickerLabels,
                datasets: [{
                    data: putsTickerData,
                    backgroundColor: putsColors,
                    borderWidth: 0.5,
                    borderColor: '#666666'
                }]
            },
            plugins: [ChartDataLabels],
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': $' + context.parsed.toLocaleString();
                            }
                        }
                    },
                    datalabels: {
                        display: true,
                        color: '#e0e0e0',
                        formatter: function(value) {
                            if (value < 500) return '';
                            return '$' + Math.round(value).toLocaleString();
                        },
                        font: {
                            size: 12,
                            weight: 'bold'
                        }
                    }
                }
            }
        });

        // Calls - By Month Chart (with cumulative line)
        const callsMonthCtx = document.getElementById('callsMonthChart').getContext('2d');
        
        // Build month-indexed data from CallsData.ByMonth
        const callsMonthMap = new Map([
            {{range $index, $data := .CallsData.ByMonth}}{{if $index}}, {{end}}["{{$data.Month}}", {{$data.Amount}}]{{end}}
        ]);
        // Align with master month labels
        const callsMonthData = serverMonthLabels.map(ym => callsMonthMap.get(ym) || 0);
        
        // Calculate cumulative calls data for individual chart
        let callsIndividualCumulativeData = [];
        let callsIndividualRunningTotal = 0;
        for (let i = 0; i < callsMonthData.length; i++) {
            callsIndividualRunningTotal += callsMonthData[i];
            callsIndividualCumulativeData.push(callsIndividualRunningTotal);
        }
        
        new Chart(callsMonthCtx, {
            type: 'bar',
            data: {
                labels: currentMonthLabels,
                datasets: [{
                    type: 'line',
                    label: 'Cumulative Calls',
                    data: callsIndividualCumulativeData,
                    borderColor: '#FFD700',
                    backgroundColor: 'rgba(255, 215, 0, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.2,
                    yAxisID: 'y1',
                    order: 1
                }, {
                    type: 'bar',
                    label: 'Monthly Calls',
                    data: callsMonthData,
                    backgroundColor: function(context) {
                        const value = context.parsed.y;
                        return value < 0 ? 'rgba(214, 39, 40, 0.6)' : 'rgba(31, 119, 180, 0.6)';
                    },
                    borderColor: function(context) {
                        const value = context.parsed.y;
                        return value < 0 ? '#d62728' : '#1f77b4';
                    },
                    borderWidth: 1,
                    yAxisID: 'y',
                    order: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        display: true,
                        position: 'top',
                        labels: {
                            color: '#e0e0e0',
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label || '';
                                return label + ': $' + context.parsed.y.toLocaleString();
                            }
                        }
                    },
                    datalabels: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            color: '#e0e0e0'
                        }
                    },
                    y: {
                        type: 'linear',
                        beginAtZero: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Monthly ($)',
                            color: '#e0e0e0'
                        },
                        ticks: {
                            color: '#e0e0e0',
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    },
                    y1: {
                        type: 'linear',
                        beginAtZero: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Cumulative ($)',
                            color: '#e0e0e0'
                        },
                        ticks: {
                            color: '#e0e0e0',
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                }
            }
        });

        // Calls - By Ticker Chart
        const callsTickerCtx = document.getElementById('callsTickerChart').getContext('2d');
        
        // Sort calls ticker data alphabetically
        const callsSorted = sortTickerData(callsTickerLabelsUnsorted, callsTickerDataUnsorted);
        const callsTickerLabels = callsSorted.labels;
        const callsTickerData = callsSorted.data;
        
        // Get consistent colors for calls symbols (using same unified list)
        const callsColors = callsTickerLabels.map(symbol => getSymbolColor(symbol, allUniqueSymbols));
        
        chartInstances.callsTicker = new Chart(callsTickerCtx, {
            type: 'pie',
            data: {
                labels: callsTickerLabels,
                datasets: [{
                    data: callsTickerData,
                    backgroundColor: callsColors,
                    borderWidth: 0.5,
                    borderColor: '#666666'
                }]
            },
            plugins: [ChartDataLabels],
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': $' + context.parsed.toLocaleString();
                            }
                        }
                    },
                    datalabels: {
                        display: true,
                        color: '#e0e0e0',
                        formatter: function(value) {
                            if (value < 500) return '';
                            return '$' + Math.round(value).toLocaleString();
                        },
                        font: {
                            size: 12,
                            weight: 'bold'
                        }
                    }
                }
            }
        });

        // Capital Gains - By Month Chart (with cumulative line)
        const capGainsMonthCtx = document.getElementById('capGainsMonthChart').getContext('2d');
        
        // Build month-indexed data from CapGainsData.ByMonth
        const capGainsMonthMap = new Map([
            {{range $index, $data := .CapGainsData.ByMonth}}{{if $index}}, {{end}}["{{$data.Month}}", {{$data.Amount}}]{{end}}
        ]);
        // Align with master month labels
        const capGainsMonthData = serverMonthLabels.map(ym => capGainsMonthMap.get(ym) || 0);
        
        // Calculate cumulative capital gains data
        let capGainsIndividualCumulativeData = [];
        let capGainsIndividualRunningTotal = 0;
        for (let i = 0; i < capGainsMonthData.length; i++) {
            capGainsIndividualRunningTotal += capGainsMonthData[i];
            capGainsIndividualCumulativeData.push(capGainsIndividualRunningTotal);
        }
        
        new Chart(capGainsMonthCtx, {
            type: 'bar',
            data: {
                labels: currentMonthLabels,
                datasets: [{
                    type: 'line',
                    label: 'Cumulative Cap Gains',
                    data: capGainsIndividualCumulativeData,
                    borderColor: '#FFD700',
                    backgroundColor: 'rgba(255, 215, 0, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.2,
                    yAxisID: 'y1',
                    order: 1
                }, {
                    type: 'bar',
                    label: 'Monthly Cap Gains',
                    data: capGainsMonthData,
                    backgroundColor: function(context) {
                        const value = context.parsed.y;
                        return value < 0 ? 'rgba(214, 39, 40, 0.6)' : 'rgba(31, 119, 180, 0.6)';
                    },
                    borderColor: function(context) {
                        const value = context.parsed.y;
                        return value < 0 ? '#d62728' : '#1f77b4';
                    },
                    borderWidth: 1,
                    yAxisID: 'y',
                    order: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        display: true,
                        position: 'top',
                        labels: {
                            color: '#e0e0e0',
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label || '';
                                return label + ': $' + context.parsed.y.toLocaleString();
                            }
                        }
                    },
                    datalabels: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            color: '#e0e0e0'
                        }
                    },
                    y: {
                        type: 'linear',
                        beginAtZero: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Monthly ($)',
                            color: '#e0e0e0'
                        },
                        ticks: {
                            color: '#e0e0e0',
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    },
                    y1: {
                        type: 'linear',
                        beginAtZero: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Cumulative ($)',
                            color: '#e0e0e0'
                        },
                        ticks: {
                            color: '#e0e0e0',
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                }
            }
        });

        // Capital Gains - By Ticker Chart
        const capGainsTickerCtx = document.getElementById('capGainsTickerChart').getContext('2d');
        const capGainsTickerDataRaw = [
            {{range $index, $data := .CapGainsData.ByTicker}}{{if $index}}, {{end}}{{$data.Amount}}{{end}}
        ];
        const capGainsTickerSorted = sortTickerData(capGainsTickerLabelsRaw, capGainsTickerDataRaw);
        const capGainsColors = capGainsTickerSorted.labels.map(symbol => getSymbolColor(symbol, allUniqueSymbols));
        chartInstances.capGainsTicker = new Chart(capGainsTickerCtx, {
            type: 'pie',
            data: {
                labels: capGainsTickerSorted.labels,
                datasets: [{
                    data: capGainsTickerSorted.data,
                    backgroundColor: capGainsColors,
                    borderWidth: 0.5,
                    borderColor: '#666666'
                }]
            },
            plugins: [ChartDataLabels],
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': $' + context.parsed.toLocaleString();
                            }
                        }
                    },
                    datalabels: {
                        display: true,
                        color: '#e0e0e0',
                        formatter: function(value) {
                            if (Math.abs(value) < 1000) return '';
                            return '$' + Math.round(value).toLocaleString();
                        },
                        font: {
                            size: 12,
                            weight: 'bold'
                        }
                    }
                }
            }
        });

        // Dividends - By Month Chart (with cumulative line)
        const dividendsMonthCtx = document.getElementById('dividendsMonthChart').getContext('2d');
        
        // Build month-indexed data from DividendsData.ByMonth
        const dividendsMonthMap = new Map([
            {{range $index, $data := .DividendsData.ByMonth}}{{if $index}}, {{end}}["{{$data.Month}}", {{$data.Amount}}]{{end}}
        ]);
        // Align with master month labels
        const dividendsMonthData = serverMonthLabels.map(ym => dividendsMonthMap.get(ym) || 0);
        
        // Calculate cumulative dividends data
        let dividendsIndividualCumulativeData = [];
        let dividendsIndividualRunningTotal = 0;
        for (let i = 0; i < dividendsMonthData.length; i++) {
            dividendsIndividualRunningTotal += dividendsMonthData[i];
            dividendsIndividualCumulativeData.push(dividendsIndividualRunningTotal);
        }
        
        new Chart(dividendsMonthCtx, {
            type: 'bar',
            data: {
                labels: currentMonthLabels,
                datasets: [{
                    type: 'line',
                    label: 'Cumulative Dividends',
                    data: dividendsIndividualCumulativeData,
                    borderColor: '#FFD700',
                    backgroundColor: 'rgba(255, 215, 0, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.2,
                    yAxisID: 'y1',
                    order: 1
                }, {
                    type: 'bar',
                    label: 'Monthly Dividends',
                    data: dividendsMonthData,
                    backgroundColor: function(context) {
                        const value = context.parsed.y;
                        return value < 0 ? 'rgba(214, 39, 40, 0.6)' : 'rgba(31, 119, 180, 0.6)';
                    },
                    borderColor: function(context) {
                        const value = context.parsed.y;
                        return value < 0 ? '#d62728' : '#1f77b4';
                    },
                    borderWidth: 1,
                    yAxisID: 'y',
                    order: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        display: true,
                        position: 'top',
                        labels: {
                            color: '#e0e0e0',
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label || '';
                                return label + ': $' + context.parsed.y.toLocaleString();
                            }
                        }
                    },
                    datalabels: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            color: '#e0e0e0'
                        }
                    },
                    y: {
                        type: 'linear',
                        beginAtZero: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Monthly ($)',
                            color: '#e0e0e0'
                        },
                        ticks: {
                            color: '#e0e0e0',
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    },
                    y1: {
                        type: 'linear',
                        beginAtZero: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Cumulative ($)',
                            color: '#e0e0e0'
                        },
                        ticks: {
                            color: '#e0e0e0',
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                }
            }
        });

        // Dividends - By Ticker Chart
        const dividendsTickerCtx = document.getElementById('dividendsTickerChart').getContext('2d');
        const dividendsTickerDataRaw = [
            {{range $index, $data := .DividendsData.ByTicker}}{{if $index}}, {{end}}{{$data.Amount}}{{end}}
        ];
        const dividendsTickerSorted = sortTickerData(dividendsTickerLabelsRaw, dividendsTickerDataRaw);
        const dividendsColors = dividendsTickerSorted.labels.map(symbol => getSymbolColor(symbol, allUniqueSymbols));
        chartInstances.dividendsTicker = new Chart(dividendsTickerCtx, {
            type: 'pie',
            data: {
                labels: dividendsTickerSorted.labels,
                datasets: [{
                    data: dividendsTickerSorted.data,
                    backgroundColor: dividendsColors,
                    borderWidth: 0.5,
                    borderColor: '#666666'
                }]
            },
            plugins: [ChartDataLabels],
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': $' + context.parsed.toLocaleString();
                            }
                        }
                    },
                    datalabels: {
                        display: true,
                        color: '#e0e0e0',
                        formatter: function(value) {
                            if (value < 100) return '';
                            return '$' + Math.round(value).toLocaleString();
                        },
                        font: {
                            size: 12,
                            weight: 'bold'
                        }
                    }
                }
            }
        });

        // Gains Over Time chart with Monthly bars and Cumulative line overlay

        // Update the totals panel with year-to-date values (using imported formatCurrency)
        function updateTotalsPanelValues(putsTotal, callsTotal, capGainsTotal, dividendsTotal) {
            const grandTotalElement = document.getElementById('grandTotal');
            const totalPutsElement = document.getElementById('totalPuts');
            const totalCallsElement = document.getElementById('totalCalls');
            const totalCapGainsElement = document.getElementById('totalCapGains');
            const totalDividendsElement = document.getElementById('totalDividends');
            
            // Calculate grand total
            const grandTotalValue = putsTotal + callsTotal + capGainsTotal + dividendsTotal;
            
            // Update each total using imported formatCurrency
            formatCurrency(grandTotalValue, grandTotalElement);
            formatCurrency(putsTotal, totalPutsElement);
            formatCurrency(callsTotal, totalCallsElement);
            formatCurrency(capGainsTotal, totalCapGainsElement);
            formatCurrency(dividendsTotal, totalDividendsElement);
        }

        // Function to create the gains chart with monthly bars and cumulative line
        function createGainsOverTimeChart() {
            const gainsOverTimeCtx = document.getElementById('cumulativeGainsChart').getContext('2d');
            
            // Use the same formatted month labels as the other charts
            const monthLabels = currentMonthLabels;
            
            // Use the same month-aligned data as the individual charts
            const putsMonthlyData = putsMonthData;
            const callsMonthlyData = callsMonthData;
            const capGainsMonthlyData = capGainsMonthData;
            const dividendsMonthlyData = dividendsMonthData;
            
            // Calculate cumulative data for each category
            let putsCumulativeData = [];
            let callsCumulativeData = [];
            let capGainsCumulativeData = [];
            let dividendsCumulativeData = [];
            
            let putsRunningTotal = 0;
            let callsRunningTotal = 0;
            let capGainsRunningTotal = 0;
            let dividendsRunningTotal = 0;
            
            for (let i = 0; i < monthLabels.length; i++) {
                putsRunningTotal += putsMonthlyData[i] || 0;
                callsRunningTotal += callsMonthlyData[i] || 0;
                capGainsRunningTotal += capGainsMonthlyData[i] || 0;
                dividendsRunningTotal += dividendsMonthlyData[i] || 0;
                
                putsCumulativeData.push(putsRunningTotal);
                callsCumulativeData.push(callsRunningTotal);
                capGainsCumulativeData.push(capGainsRunningTotal);
                dividendsCumulativeData.push(dividendsRunningTotal);
            }
            
            // Update totals panel with year-to-date values
            updateTotalsPanelValues(putsRunningTotal, callsRunningTotal, capGainsRunningTotal, dividendsRunningTotal);
            
            // Calculate total cumulative for the line
            let totalCumulativeData = [];
            for (let i = 0; i < monthLabels.length; i++) {
                totalCumulativeData.push(
                    putsCumulativeData[i] + 
                    callsCumulativeData[i] + 
                    capGainsCumulativeData[i] + 
                    dividendsCumulativeData[i]
                );
            }
            
            // Create datasets with monthly bars (stacked) and cumulative line
            const datasets = [
                // Monthly stacked bars
                {
                    type: 'bar',
                    label: 'Puts',
                    data: putsMonthlyData,
                    backgroundColor: 'rgba(31, 119, 180, 0.8)',
                    borderColor: '#1f77b4',
                    borderWidth: 1,
                    stack: 'stack0',
                    yAxisID: 'y'
                },
                {
                    type: 'bar',
                    label: 'Calls',
                    data: callsMonthlyData,
                    backgroundColor: 'rgba(255, 127, 14, 0.8)',
                    borderColor: '#ff7f0e',
                    borderWidth: 1,
                    stack: 'stack0',
                    yAxisID: 'y'
                },
                {
                    type: 'bar',
                    label: 'Capital Gains',
                    data: capGainsMonthlyData,
                    backgroundColor: 'rgba(39, 174, 96, 0.8)',
                    borderColor: '#27ae60',
                    borderWidth: 1,
                    stack: 'stack0',
                    yAxisID: 'y'
                },
                {
                    type: 'bar',
                    label: 'Dividends',
                    data: dividendsMonthlyData,
                    backgroundColor: 'rgba(255, 215, 0, 0.8)',
                    borderColor: '#FFD700',
                    borderWidth: 1,
                    stack: 'stack0',
                    yAxisID: 'y'
                },
                // Cumulative line
                {
                    type: 'line',
                    label: 'Cumulative',
                    data: totalCumulativeData,
                    borderColor: '#FFD700',
                    backgroundColor: 'rgba(255, 215, 0, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.2,
                    yAxisID: 'y1',
                    order: 0
                }
            ];
            
            // Create chart
            new Chart(gainsOverTimeCtx, {
                type: 'bar',
                data: {
                    labels: monthLabels,
                    datasets: datasets
                },
                plugins: [ChartDataLabels],
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            title: {
                                display: false
                            },
                            ticks: {
                                color: '#e0e0e0'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            stacked: true,
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Monthly Gains ($)',
                                color: '#e0e0e0'
                            },
                            ticks: {
                                color: '#e0e0e0',
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Cumulative ($)',
                                color: '#FFD700'
                            },
                            ticks: {
                                color: '#FFD700',
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    },
                    plugins: {
                        legend: { 
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                                },
                                footer: function(tooltipItems) {
                                    let total = 0;
                                    tooltipItems.forEach(function(tooltipItem) {
                                        total += tooltipItem.parsed.y;
                                    });
                                    return 'Total: $' + total.toLocaleString();
                                }
                            }
                        },
                        datalabels: {
                            display: function(context) {
                                // Only show on the last bar dataset (top of stack)
                                const datasets = context.chart.data.datasets;
                                let lastBarIndex = -1;
                                for (let i = datasets.length - 1; i >= 0; i--) {
                                    if (datasets[i].type === 'bar') {
                                        lastBarIndex = i;
                                        break;
                                    }
                                }
                                return context.datasetIndex === lastBarIndex;
                            },
                            formatter: function(value, context) {
                                // Calculate total for this month across all stacked bar datasets
                                let total = 0;
                                for (let i = 0; i < context.chart.data.datasets.length; i++) {
                                    if (context.chart.data.datasets[i].type === 'bar') {
                                        total += context.chart.data.datasets[i].data[context.dataIndex] || 0;
                                    }
                                }
                                return total > 0 ? '$' + (total / 1000).toFixed(1) + 'K' : '';
                            },
                            color: '#ffffff',
                            font: {
                                size: 12,
                                weight: 'bold'
                            },
                            anchor: 'end',
                            align: 'top',
                            offset: 4
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    }
                }
            });
        }

        // Initialize chart
        createGainsOverTimeChart();

        // Function to create cumulative income pie chart
        function createCumulativeIncomePieChart() {
            const ctx = document.getElementById('cumulativeIncomePieChart');
            if (!ctx) return;
            
            // Get cumulative totals from the page (already calculated)
            const totalPuts = parseFloat(document.getElementById('totalPuts').textContent.replace(/[$,]/g, '')) || 0;
            const totalCalls = parseFloat(document.getElementById('totalCalls').textContent.replace(/[$,]/g, '')) || 0;
            const totalCapGains = parseFloat(document.getElementById('totalCapGains').textContent.replace(/[$,]/g, '')) || 0;
            const totalDividends = parseFloat(document.getElementById('totalDividends').textContent.replace(/[$,]/g, '')) || 0;
            
            // Plugin to draw total in center of donut
            const centerTextPlugin = {
                id: 'centerText',
                afterDatasetsDraw: function(chart) {
                    const ctx = chart.ctx;
                    const chartArea = chart.chartArea;
                    const centerX = (chartArea.left + chartArea.right) / 2;
                    const centerY = (chartArea.top + chartArea.bottom) / 2;
                    
                    const total = chart.data.datasets[0].data.reduce((sum, val) => sum + val, 0);
                    
                    ctx.save();
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    
                    // Draw "Total" label
                    ctx.font = 'bold 14px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
                    ctx.fillStyle = '#a0a0a0';
                    ctx.fillText('Total', centerX, centerY - 15);
                    
                    // Draw total value
                    ctx.font = 'bold 20px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
                    ctx.fillStyle = '#ffffff';
                    ctx.fillText('$' + Math.round(total).toLocaleString(), centerX, centerY + 15);
                    
                    ctx.restore();
                }
            };
            
            // Create donut chart
            new Chart(ctx, {
                type: 'doughnut',
                plugins: [centerTextPlugin],
                data: {
                    labels: ['Puts', 'Calls', 'Capital Gains', 'Dividends'],
                    datasets: [{
                        data: [totalPuts, totalCalls, totalCapGains, totalDividends],
                        backgroundColor: [
                            'rgba(31, 119, 180, 0.8)',
                            'rgba(255, 127, 14, 0.8)',
                            'rgba(39, 174, 96, 0.8)',
                            'rgba(255, 215, 0, 0.8)'
                        ],
                        borderColor: [
                            '#1f77b4',
                            '#ff7f0e',
                            '#27ae60',
                            '#FFD700'
                        ],
                        borderWidth: 2
                    }]
                },
                plugins: [ChartDataLabels, centerTextPlugin],
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    layout: {
                        padding: {
                            left: 10,
                            right: 10,
                            top: 10,
                            bottom: 10
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'right',
                            align: 'center',
                            labels: {
                                color: '#e0e0e0',
                                font: { size: 13 },
                                padding: 15,
                                usePointStyle: true,
                                boxWidth: 16,
                                boxHeight: 16,
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const formattedValue = '$' + Math.round(value).toLocaleString();
                                            return {
                                                text: label + ': ' + formattedValue,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                hidden: false,
                                                index: i,
                                                strokeStyle: data.datasets[0].borderColor[i],
                                                lineWidth: 2,
                                                fontColor: '#e0e0e0'
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return label + ': $' + value.toLocaleString() + ' (' + percentage + '%)';
                                }
                            }
                        },
                        datalabels: {
                            display: true,
                            color: '#ffffff',
                            font: {
                                size: 11,
                                weight: 'bold'
                            },
                            formatter: function(value, context) {
                                const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                if (total === 0 || value === 0) return '';
                                const percentage = ((value / total) * 100).toFixed(1);
                                if (percentage < 5) return ''; // Hide small slices
                                return percentage + '%';
                            },
                            anchor: 'center',
                            align: 'center'
                        }
                    }
                }
            });
        }
        
        // Initialize cumulative income pie chart after totals are updated
        // Need to wait for totals to be calculated first
        setTimeout(createCumulativeIncomePieChart, 100);

        
        // Symbol Modal functionality is handled by shared module
        
        // Apply table formatting when page loads (using imported utility)
        document.addEventListener('DOMContentLoaded', applyMonthlyTableFormatting);
        applyMonthlyTableFormatting();

        // Monthly Premiums Grouped Bar Chart using Options Index
        function createMonthlyPremiumsGroupedChart() {
            const ctx = document.getElementById('monthlyPremiumsGroupedChart');
            if (!ctx) return;

            // Get options index from template data
            let optionsIndex;
            try {
                optionsIndex = {{.OptionsIndexJSON}};
                console.log('Monthly: Options index loaded:', optionsIndex);
            } catch (e) {
                console.error('Monthly: Failed to parse options index:', e);
                return;
            }

            if (!optionsIndex || !optionsIndex.id) {
                console.warn('Monthly: No options data available');
                return;
            }

            // Get date filter from template (backend-provided date range)
            const fromMonth = '{{.SelectedFromDate}}';
            const toMonth = '{{.SelectedToDate}}';
            
            // Get all options as array and filter by date range
            const allOptions = Object.values(optionsIndex.id).filter(option => {
                const yearMonth = option.opened.substring(0, 7); // Extract "yyyy-mm"
                
                // Apply same date filtering as backend
                if (fromMonth && yearMonth < fromMonth) return false;
                if (toMonth && yearMonth > toMonth) return false;
                
                return true;
            });
            
            // Extract distinct yyyy-mm dates from filtered options and sort them
            const yearMonthSet = new Set();
            allOptions.forEach(option => {
                const dateStr = option.opened;
                const yearMonth = dateStr.substring(0, 7); // Extract "yyyy-mm"
                yearMonthSet.add(yearMonth);
            });
            
            // Sort year-months ascending
            const sortedYearMonths = Array.from(yearMonthSet).sort();
            
            // Create display labels (e.g., "2025-01" -> "Jan 2025") using imported MONTH_NAMES
            const monthLabels = sortedYearMonths.map(ym => {
                const [year, month] = ym.split('-');
                return `${MONTH_NAMES[parseInt(month) - 1]} ${year}`;
            });
            
            // Process options by year-month and group by symbol and open/closed status
            const monthlyData = {};
            
            allOptions.forEach(option => {
                // Use opened date for premium realization (when premium was received)
                // Parse yyyy-mm directly from ISO date string
                const dateStr = option.opened;
                const yearMonth = dateStr.substring(0, 7); // Extract "yyyy-mm"
                
                if (!monthlyData[yearMonth]) {
                    monthlyData[yearMonth] = {};
                }
                
                if (!monthlyData[yearMonth][option.symbol]) {
                    monthlyData[yearMonth][option.symbol] = { open: 0, closed: 0 };
                }
                
                // Calculate total profit for this option (same logic as Go backend)
                let totalProfit = option.premium * option.contracts * 100;
                if (option.closed && option.exit_price) {
                    totalProfit -= option.exit_price * option.contracts * 100;
                }
                if (option.commission) {
                    totalProfit -= option.commission;
                }
                
                // Group by open/closed status
                if (option.closed) {
                    monthlyData[yearMonth][option.symbol].closed += totalProfit;
                } else {
                    monthlyData[yearMonth][option.symbol].open += totalProfit;
                }
            });

            // Use dynamic month labels based on actual data
            const currentMonthLabels = monthLabels;
            
            // Extract all symbols that appear in the data and calculate total profit for sorting
            const symbolTotals = {};
            Object.values(monthlyData).forEach(monthData => {
                Object.keys(monthData).forEach(symbol => {
                    if (!symbolTotals[symbol]) {
                        symbolTotals[symbol] = 0;
                    }
                    symbolTotals[symbol] += monthData[symbol].closed + monthData[symbol].open;
                });
            });
            
            // Sort symbols by total profit descending (largest to smallest)
            const sortedSymbols = Object.keys(symbolTotals).sort((a, b) => symbolTotals[b] - symbolTotals[a]);
            
            // Build datasets - one stack for Open positions, one stack for Closed positions
            // Within each stack, aggregate all symbols
            const datasets = [];
            
            // Calculate max total for suggestedMax (to ensure labels don't get cut off)
            let maxTotal = 0;
            sortedYearMonths.forEach(ym => {
                let monthTotal = 0;
                sortedSymbols.forEach(symbol => {
                    if (monthlyData[ym] && monthlyData[ym][symbol]) {
                        monthTotal += monthlyData[ym][symbol].closed + monthlyData[ym][symbol].open;
                    }
                });
                if (monthTotal > maxTotal) {
                    maxTotal = monthTotal;
                }
            });
            const suggestedMax = maxTotal * 1.1; // Add 10% headroom
            
            sortedSymbols.forEach((symbol, index) => {
                const baseColor = getSymbolColor(symbol, allUniqueSymbols);
                
                // Dataset for this symbol's closed positions (will be stacked together)
                const closedData = sortedYearMonths.map(ym => {
                    return monthlyData[ym] && monthlyData[ym][symbol] ? monthlyData[ym][symbol].closed : 0;
                });
                
                datasets.push({
                    label: symbol + ' (Closed)',
                    data: closedData,
                    backgroundColor: baseColor,
                    borderColor: baseColor,
                    borderWidth: 1,
                    stack: 'closed', // All closed positions in one stack
                    order: 1 // Closed stack first
                });
                
                // Dataset for this symbol's open positions (will be stacked together)
                const openData = sortedYearMonths.map(ym => {
                    return monthlyData[ym] && monthlyData[ym][symbol] ? monthlyData[ym][symbol].open : 0;
                });
                
                // Use same color but with transparency to distinguish from closed
                const openColor = baseColor + '80'; // Add alpha for transparency
                
                datasets.push({
                    label: symbol + ' (Open)',
                    data: openData,
                    backgroundColor: openColor,
                    borderColor: baseColor,
                    borderWidth: 1,
                    stack: 'open', // All open positions in one stack
                    order: 2 // Open stack second
                });
            });

            chartInstances.monthlyPremiums = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: currentMonthLabels,
                    datasets: datasets
                },
                plugins: [ChartDataLabels],
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        x: {
                            grid: {
                                color: '#404040'
                            },
                            ticks: {
                                color: '#e0e0e0'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            suggestedMax: suggestedMax,
                            grid: {
                                color: '#404040'
                            },
                            ticks: {
                                color: '#e0e0e0',
                                callback: function(value) {
                                    return '$' + Math.round(value).toLocaleString();
                                }
                            },
                            title: {
                                display: true,
                                text: 'Monthly Premiums ($)',
                                color: '#e0e0e0'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(20, 20, 20, 0.95)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#007acc',
                            borderWidth: 2,
                            cornerRadius: 8,
                            padding: 16,
                            displayColors: false,
                            titleFont: {
                                size: 16,
                                weight: 'bold',
                                family: 'monospace'
                            },
                            bodyFont: {
                                size: 13,
                                family: 'monospace'
                            },
                            caretSize: 8,
                            position: 'nearest',
                            enabled: false, // Disable default tooltip
                            external: function(context) {
                                // Custom tooltip implementation for table layout
                                const {chart, tooltip} = context;
                                
                                // Remove existing custom tooltip
                                let tooltipEl = document.getElementById('chartjs-tooltip');
                                if (!tooltipEl) {
                                    tooltipEl = document.createElement('div');
                                    tooltipEl.id = 'chartjs-tooltip';
                                    document.body.appendChild(tooltipEl);
                                }
                                
                                // Hide tooltip if no data
                                if (tooltip.opacity === 0) {
                                    tooltipEl.style.opacity = 0;
                                    tooltipEl.style.visibility = 'hidden';
                                    return;
                                }
                                
                                if (tooltip.body && tooltip.dataPoints && tooltip.dataPoints.length > 0) {
                                    const monthIndex = tooltip.dataPoints[0].dataIndex;
                                    const monthLabel = currentMonthLabels[monthIndex];
                                    const yearMonth = sortedYearMonths[monthIndex];
                                    
                                    if (!yearMonth || !monthlyData[yearMonth]) {
                                        tooltipEl.style.opacity = 0;
                                        return;
                                    }
                                    
                                    // Calculate comprehensive summary for the month
                                    let openTotal = 0;
                                    let closedTotal = 0;
                                    const symbolSummary = {};
                                    
                                    sortedSymbols.forEach(symbol => {
                                        const monthData = monthlyData[yearMonth] && monthlyData[yearMonth][symbol];
                                        if (monthData) {
                                            const symbolOpen = monthData.open || 0;
                                            const symbolClosed = monthData.closed || 0;
                                            const symbolTotal = symbolOpen + symbolClosed;
                                            
                                            // Include all symbols with non-zero values (positive or negative)
                                            if (symbolTotal !== 0) {
                                                symbolSummary[symbol] = {
                                                    open: symbolOpen,
                                                    closed: symbolClosed,
                                                    total: symbolTotal
                                                };
                                                
                                                openTotal += symbolOpen;
                                                closedTotal += symbolClosed;
                                            }
                                        }
                                    });
                                    
                                    const grandTotal = openTotal + closedTotal;
                                    const symbolKeys = Object.keys(symbolSummary).sort();
                                    
                                    // Build HTML table content
                                    let html = `
                                        <div style="
                                            background: rgba(20, 20, 20, 0.95);
                                            border: 2px solid #007acc;
                                            border-radius: 8px;
                                            padding: 16px;
                                            font-family: monospace;
                                            color: #ffffff;
                                            width: 600px;
                                            max-width: 90vw;
                                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                                        ">
                                            <div style="
                                                font-size: 16px;
                                                font-weight: bold;
                                                text-align: center;
                                                margin-bottom: 16px;
                                                padding-bottom: 8px;
                                                border-bottom: 1px solid #007acc;
                                                color: #007acc;
                                            ">
                                                ${monthLabel} Monthly Premiums Summary
                                            </div>
                                            
                                            <!-- Summary Totals Table -->
                                            <table style="
                                                width: 100%;
                                                margin-bottom: 16px;
                                                border-collapse: collapse;
                                                background: rgba(0, 122, 204, 0.1);
                                                border-radius: 4px;
                                            ">
                                                <tr>
                                                    <td style="padding: 8px 12px; font-weight: bold; width: 25%;">TOTAL MONTH:</td>
                                                    <td style="padding: 8px 12px; font-weight: bold; color: ${grandTotal < 0 ? '#e74c3c' : '#27ae60'};">${grandTotal < 0 ? '-' : ''}$${Math.round(Math.abs(grandTotal)).toLocaleString()}</td>
                                                    <td style="padding: 8px 12px; font-weight: bold; width: 25%;">CLOSED:</td>
                                                    <td style="padding: 8px 12px; font-weight: bold; color: ${closedTotal < 0 ? '#e74c3c' : '#ffffff'};">${closedTotal < 0 ? '-' : ''}$${Math.round(Math.abs(closedTotal)).toLocaleString()}</td>
                                                </tr>
                                                <tr>
                                                    <td style="padding: 8px 12px; font-weight: bold;">SYMBOLS:</td>
                                                    <td style="padding: 8px 12px; font-weight: bold; color: #ffffff;">${symbolKeys.length}</td>
                                                    <td style="padding: 8px 12px; font-weight: bold;">OPEN:</td>
                                                    <td style="padding: 8px 12px; font-weight: bold; color: ${openTotal < 0 ? '#e74c3c' : '#ffffff'};">${openTotal < 0 ? '-' : ''}$${Math.round(Math.abs(openTotal)).toLocaleString()}</td>
                                                </tr>
                                            </table>
                                            
                                            <!-- Detailed Breakdown Table -->
                                            <div style="
                                                font-size: 14px;
                                                font-weight: bold;
                                                margin-bottom: 8px;
                                                color: #007acc;
                                            ">BREAKDOWN BY SYMBOL</div>
                                            
                                            <table style="
                                                width: 100%;
                                                border-collapse: collapse;
                                                font-size: 12px;
                                                background: rgba(255, 255, 255, 0.05);
                                            ">
                                                <thead>
                                                    <tr style="background: rgba(0, 122, 204, 0.3);">
                                                        <th style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #404040;">SYMBOL</th>
                                                        <th style="padding: 6px 8px; text-align: right; border-bottom: 1px solid #404040;">TOTAL</th>
                                                        <th style="padding: 6px 8px; text-align: right; border-bottom: 1px solid #404040;">CLOSED</th>
                                                        <th style="padding: 6px 8px; text-align: right; border-bottom: 1px solid #404040;">OPEN</th>
                                                        <th style="padding: 6px 8px; text-align: right; border-bottom: 1px solid #404040;">% OF MONTH</th>
                                                    </tr>
                                                </thead>
                                                <tbody>`;
                                    
                                    symbolKeys.forEach((symbol, index) => {
                                        const data = symbolSummary[symbol];
                                        const percentage = grandTotal !== 0 ? ((Math.abs(data.total) / Math.abs(grandTotal)) * 100).toFixed(1) : '0.0';
                                        const rowBg = index % 2 === 0 ? 'rgba(255, 255, 255, 0.02)' : 'transparent';
                                        
                                        // Color coding for positive/negative values
                                        const totalColor = data.total < 0 ? '#e74c3c' : '#27ae60';
                                        const closedColor = data.closed < 0 ? '#e74c3c' : '#ffffff';
                                        const openColor = data.open < 0 ? '#e74c3c' : '#ffffff';
                                        
                                        // Format values properly with negative signs
                                        const formatValue = (value) => {
                                            const absValue = Math.abs(value);
                                            return value < 0 ? `-$${Math.round(absValue).toLocaleString()}` : `$${Math.round(absValue).toLocaleString()}`;
                                        };
                                        
                                        html += `
                                            <tr style="background: ${rowBg};">
                                                <td style="padding: 4px 8px; font-weight: bold;">${symbol}</td>
                                                <td style="padding: 4px 8px; text-align: right; font-weight: bold; color: ${totalColor};">${formatValue(data.total)}</td>
                                                <td style="padding: 4px 8px; text-align: right; color: ${closedColor};">${formatValue(data.closed)}</td>
                                                <td style="padding: 4px 8px; text-align: right; color: ${openColor};">${formatValue(data.open)}</td>
                                                <td style="padding: 4px 8px; text-align: right; color: #ffa500;">${percentage}%</td>
                                            </tr>`;
                                    });
                                    
                                    html += `
                                                </tbody>
                                            </table>
                                        </div>`;
                                    
                                    tooltipEl.innerHTML = html;
                                }
                                
                                // Position tooltip with viewport boundary detection
                                const canvasRect = chart.canvas.getBoundingClientRect();
                                
                                // Calculate desired position (centered horizontally, 50px above cursor)
                                let leftPos = canvasRect.left + window.scrollX + tooltip.caretX - 300;
                                let topPos = canvasRect.top + window.scrollY + tooltip.caretY - 50;
                                
                                // Get tooltip dimensions (assume 600px width from inline style)
                                const tooltipWidth = 600;
                                const tooltipHeight = 400; // Approximate height
                                
                                // Ensure tooltip stays within horizontal viewport bounds
                                const viewportWidth = window.innerWidth;
                                const minLeft = 10; // 10px margin from left edge
                                const maxLeft = viewportWidth - tooltipWidth - 10; // 10px margin from right edge
                                
                                if (leftPos < minLeft) {
                                    leftPos = minLeft;
                                } else if (leftPos > maxLeft) {
                                    leftPos = maxLeft;
                                }
                                
                                // Ensure tooltip stays within vertical viewport bounds
                                const viewportHeight = window.innerHeight;
                                const minTop = 10; // 10px margin from top edge
                                const maxTop = viewportHeight - tooltipHeight - 10; // 10px margin from bottom edge
                                
                                if (topPos < minTop) {
                                    topPos = minTop;
                                } else if (topPos > maxTop) {
                                    topPos = maxTop;
                                }
                                
                                tooltipEl.style.opacity = 1;
                                tooltipEl.style.visibility = 'visible';
                                tooltipEl.style.position = 'absolute';
                                tooltipEl.style.left = leftPos + 'px';
                                tooltipEl.style.top = topPos + 'px';
                                tooltipEl.style.pointerEvents = 'none';
                                tooltipEl.style.zIndex = '9999';
                            }
                        },
                        datalabels: {
                            display: false // Disable for grouped bars to avoid clutter
                        }
                    }
                },
                plugins: [{
                    id: 'stackTotals',
                    afterDatasetsDraw: function(chart) {
                        const ctx = chart.ctx;
                        ctx.save();
                        
                        // Set font for stack totals
                        ctx.font = 'bold 12px Arial';
                        ctx.fillStyle = '#27ae60';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'bottom';
                        
                        // Calculate totals for each month and stack
                        chart.data.labels.forEach((label, monthIndex) => {
                            const yearMonth = sortedYearMonths[monthIndex];
                            
                            // Calculate totals for this month
                            let openTotal = 0;
                            let closedTotal = 0;
                            
                            sortedSymbols.forEach(symbol => {
                                const monthData = monthlyData[yearMonth] && monthlyData[yearMonth][symbol];
                                if (monthData) {
                                    openTotal += monthData.open;
                                    closedTotal += monthData.closed;
                                }
                            });
                            
                            // Find the top of each stack
                            let openStackTop = chart.chartArea.bottom;
                            let closedStackTop = chart.chartArea.bottom;
                            let openStackX = null;
                            let closedStackX = null;
                            
                            // Get the positions from the chart metadata
                            chart.data.datasets.forEach((dataset, datasetIndex) => {
                                const meta = chart.getDatasetMeta(datasetIndex);
                                if (meta.data[monthIndex] && dataset.data[monthIndex] > 0) {
                                    const bar = meta.data[monthIndex];
                                    
                                    if (dataset.stack === 'open') {
                                        if (bar.y < openStackTop) {
                                            openStackTop = bar.y;
                                            openStackX = bar.x;
                                        }
                                    } else if (dataset.stack === 'closed') {
                                        if (bar.y < closedStackTop) {
                                            closedStackTop = bar.y;
                                            closedStackX = bar.x;
                                        }
                                    }
                                }
                            });
                            
                            // Draw the totals above each stack
                            if (closedTotal > 0 && closedStackX !== null) {
                                const formattedClosedTotal = '$' + Math.round(closedTotal).toLocaleString();
                                ctx.fillText(formattedClosedTotal, closedStackX, closedStackTop - 5);
                            }
                            
                            if (openTotal > 0 && openStackX !== null) {
                                const formattedOpenTotal = '$' + Math.round(openTotal).toLocaleString();
                                ctx.fillText(formattedOpenTotal, openStackX, openStackTop - 5);
                            }
                        });
                        
                        ctx.restore();
                    }
                }]
            });
        }

        // Create the grouped bar chart when page loads
        document.addEventListener('DOMContentLoaded', function() {
            createMonthlyPremiumsGroupedChart();

            // Get initial values from template
            const initialFrom = '{{.SelectedFromDate}}';
            const initialTo = '{{.SelectedToDate}}';
            
            // Set initial display value (default to "Last 12 months")
            if (initialFrom && initialTo) {
                const fromMoment = moment(initialFrom + '-01', 'YYYY-MM-DD');
                const toMoment = moment(initialTo + '-01', 'YYYY-MM-DD');
                $('#monthRange').val(fromMoment.format('MMM YYYY') + ' - ' + toMoment.format('MMM YYYY'));
            } else {
                $('#monthRange').val('Last 12 months');
            }
            
            // Create custom month picker
            let startMonth = null;
            let endMonth = null;
            let pickerOpen = false;
            
            $('#monthRange').on('click', function() {
                if (pickerOpen) return;
                pickerOpen = true;
                
                const input = $(this);
                const offset = input.offset();
                
                // Create month picker overlay
                const $overlay = $('<div class="month-range-overlay"></div>').css({
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    zIndex: 9998
                });
                
                // Create shortcuts panel
                const $shortcuts = $('<div class="shortcuts"></div>').css({
                    display: 'flex',
                    flexDirection: 'column',
                    gap: '5px',
                    borderRight: '1px solid #575757',
                    paddingRight: '15px'
                });
                
                const shortcuts = [
                    { label: 'This year', calc: () => [moment().startOf('year'), moment().startOf('month')] },
                    { label: 'Last year', calc: () => [moment().subtract(1, 'year').startOf('year'), moment().subtract(1, 'year').endOf('year')] },
                    { label: 'Last 6 months', calc: () => [moment().subtract(5, 'months').startOf('month'), moment().startOf('month')] },
                    { label: 'Last 12 months', calc: () => [moment().subtract(11, 'months').startOf('month'), moment().startOf('month')] }
                ];
                
                shortcuts.forEach(sc => {
                    const $btn = $('<button></button>').text(sc.label).css({
                        padding: '8px 12px',
                        background: '#1a1a1a',
                        border: '1px solid #575757',
                        borderRadius: '4px',
                        color: '#e0e0e0',
                        cursor: 'pointer',
                        fontSize: '14px',
                        textAlign: 'left',
                        whiteSpace: 'nowrap'
                    }).on('mouseenter', function() {
                        $(this).css('background', '#404040');
                    }).on('mouseleave', function() {
                        $(this).css('background', '#1a1a1a');
                    }).on('click', function() {
                        const [start, end] = sc.calc();
                        applyRange(start, end);
                    });
                    $shortcuts.append($btn);
                });
                
                // Create calendars container
                const $calendars = $('<div class="calendars"></div>').css({
                    display: 'flex',
                    gap: '15px'
                });
                
                // Create two year-month pickers
                function createYearMonthPicker(year, isStart) {
                    const $container = $('<div class="year-month-picker"></div>');
                    
                    const $header = $('<div class="picker-header"></div>').css({
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        marginBottom: '10px'
                    });
                    
                    const $prevBtn = $('<button>&lt;</button>').css({
                        background: '#1a1a1a',
                        border: '1px solid #575757',
                        color: '#e0e0e0',
                        padding: '5px 10px',
                        borderRadius: '4px',
                        cursor: 'pointer'
                    }).on('click', function() {
                        updateYearMonthPicker(isStart, year - 1);
                    });
                    
                    const $yearLabel = $('<span></span>').text(year).css({
                        color: '#e0e0e0',
                        fontSize: '16px',
                        fontWeight: 'bold'
                    });
                    
                    const $nextBtn = $('<button>&gt;</button>').css({
                        background: '#1a1a1a',
                        border: '1px solid #575757',
                        color: '#e0e0e0',
                        padding: '5px 10px',
                        borderRadius: '4px',
                        cursor: 'pointer'
                    }).on('click', function() {
                        updateYearMonthPicker(isStart, year + 1);
                    });
                    
                    $header.append($prevBtn, $yearLabel, $nextBtn);
                    
                    const $months = $('<div class="months-grid"></div>').css({
                        display: 'grid',
                        gridTemplateColumns: 'repeat(3, 1fr)',
                        gap: '8px'
                    });
                    
                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    monthNames.forEach((name, idx) => {
                        const $month = $('<div></div>').text(name).css({
                            padding: '12px',
                            textAlign: 'center',
                            background: '#1a1a1a',
                            border: '1px solid #575757',
                            borderRadius: '4px',
                            color: '#e0e0e0',
                            cursor: 'pointer'
                        }).on('mouseenter', function() {
                            if (!$(this).hasClass('active')) {
                                $(this).css('background', '#404040');
                            }
                        }).on('mouseleave', function() {
                            if (!$(this).hasClass('active')) {
                                $(this).css('background', '#1a1a1a');
                            }
                        }).on('click', function() {
                            const selectedMoment = moment().year(year).month(idx).startOf('month');
                            if (isStart) {
                                startMonth = selectedMoment;
                                if (endMonth && startMonth.isAfter(endMonth)) {
                                    endMonth = startMonth.clone();
                                }
                            } else {
                                endMonth = selectedMoment;
                                if (startMonth && endMonth.isBefore(startMonth)) {
                                    startMonth = endMonth.clone();
                                }
                            }
                            updateSelection();
                        });
                        $months.append($month);
                    });
                    
                    $container.append($header, $months);
                    return $container;
                }
                
                function updateYearMonthPicker(isStart, newYear) {
                    $calendars.empty();
                    const startYear = isStart ? newYear : (startMonth ? startMonth.year() : moment().subtract(1, 'year').year());
                    const endYear = !isStart ? newYear : (endMonth ? endMonth.year() : moment().year());
                    $calendars.append(createYearMonthPicker(startYear, true));
                    $calendars.append(createYearMonthPicker(endYear, false));
                    updateSelection();
                }
                
                function updateSelection() {
                    $('.months-grid div').removeClass('active').css('background', '#1a1a1a');
                    if (startMonth) {
                        const startIdx = startMonth.month();
                        $('.months-grid').eq(0).find('div').eq(startIdx).addClass('active').css('background', '#27ae60');
                    }
                    if (endMonth) {
                        const endIdx = endMonth.month();
                        $('.months-grid').eq(1).find('div').eq(endIdx).addClass('active').css('background', '#27ae60');
                    }
                }
                
                function applyRange(start, end) {
                    const fromMonth = start.format('YYYY-MM');
                    const toMonth = end.format('YYYY-MM');
                    
                    const url = new URL(window.location.href);
                    url.searchParams.set('from', fromMonth);
                    url.searchParams.set('to', toMonth);
                    window.location.href = url.toString();
                }
                
                // Initialize with current selection
                if (initialFrom) {
                    startMonth = moment(initialFrom + '-01', 'YYYY-MM-DD');
                }
                if (initialTo) {
                    endMonth = moment(initialTo + '-01', 'YYYY-MM-DD');
                }
                
                const startYear = startMonth ? startMonth.year() : moment().subtract(1, 'year').year();
                const endYear = endMonth ? endMonth.year() : moment().year();
                
                $calendars.append(createYearMonthPicker(startYear, true));
                $calendars.append(createYearMonthPicker(endYear, false));
                
                // Create buttons
                const $buttons = $('<div class="picker-buttons"></div>').css({
                    display: 'flex',
                    justifyContent: 'flex-end',
                    gap: '10px',
                    marginTop: '15px',
                    paddingTop: '15px',
                    borderTop: '1px solid #575757'
                });
                
                const $cancelBtn = $('<button>Cancel</button>').css({
                    padding: '8px 16px',
                    background: '#1a1a1a',
                    border: '1px solid #575757',
                    borderRadius: '4px',
                    color: '#e0e0e0',
                    cursor: 'pointer'
                }).on('click', function() {
                    closePicker();
                });
                
                const $applyBtn = $('<button>Apply</button>').css({
                    padding: '8px 16px',
                    background: '#27ae60',
                    border: 'none',
                    borderRadius: '4px',
                    color: '#fff',
                    cursor: 'pointer'
                }).on('click', function() {
                    if (startMonth && endMonth) {
                        applyRange(startMonth, endMonth);
                    }
                });
                
                $buttons.append($cancelBtn, $applyBtn);
                
                // Create main container
                const $mainContainer = $('<div class="calendars-container"></div>').css({
                    display: 'flex',
                    gap: '15px'
                });
                $mainContainer.append($shortcuts, $calendars);
                
                // Build picker wrapper
                const $pickerWrapper = $('<div></div>').css({
                    position: 'absolute',
                    top: offset.top + input.outerHeight() + 5,
                    left: offset.left,
                    background: '#2d2d2d',
                    border: '1px solid #575757',
                    borderRadius: '4px',
                    padding: '15px',
                    zIndex: 9999,
                    minWidth: '600px'
                });
                
                $pickerWrapper.append($mainContainer, $buttons);
                
                function closePicker() {
                    $overlay.remove();
                    $pickerWrapper.remove();
                    pickerOpen = false;
                }
                
                $overlay.on('click', closePicker);

                $('body').append($overlay, $pickerWrapper);
                updateSelection();
            });
        });

        // Collateral & APR Chart
        const collateralData = [{{range $i, $d := .CollateralByMonth}}{{if $i}},{{end}}{{$d.Amount}}{{end}}];
        const aprData = [{{range $i, $d := .APRByMonth}}{{if $i}},{{end}}{{$d.Amount}}{{end}}];

        const collateralCtx = document.getElementById('collateralAPRChart').getContext('2d');
        new Chart(collateralCtx, {
            type: 'bar',
            data: {
                labels: currentMonthLabels,
                datasets: [{
                    type: 'line',
                    label: 'Annualized APR (%)',
                    data: aprData,
                    borderColor: '#FFD700',
                    backgroundColor: 'rgba(255, 215, 0, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.2,
                    yAxisID: 'y1',
                    order: 1
                }, {
                    type: 'bar',
                    label: 'Max Collateral ($)',
                    data: collateralData,
                    backgroundColor: 'rgba(52, 152, 219, 0.6)',
                    borderColor: '#3498db',
                    borderWidth: 1,
                    yAxisID: 'y',
                    order: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { labels: { color: '#e0e0e0' } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                if (context.dataset.yAxisID === 'y1') {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                                }
                                return context.dataset.label + ': $' + context.parsed.y.toLocaleString('en-US', {maximumFractionDigits: 0});
                            }
                        }
                    },
                    datalabels: { display: false }
                },
                scales: {
                    x: { ticks: { color: '#a0a0a0' }, grid: { color: '#404040' } },
                    y: {
                        type: 'linear',
                        position: 'left',
                        ticks: {
                            color: '#a0a0a0',
                            callback: val => '$' + val.toLocaleString('en-US', {maximumFractionDigits: 0})
                        },
                        grid: { color: '#404040' }
                    },
                    y1: {
                        type: 'linear',
                        position: 'right',
                        ticks: {
                            color: '#FFD700',
                            callback: val => val.toFixed(1) + '%'
                        },
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });
    </script>
    <script src="/static/js/navigation.js"></script>
    <script src="/static/js/symbol-modal.js"></script>
    <script src="/static/js/table-sort.js"></script>

</body>
</html>
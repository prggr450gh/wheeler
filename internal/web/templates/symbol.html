<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Symbol}} - Wheeler</title>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/styles.css?v=2">
    <style>
        /* Option 1: Underline/Border Accent Tabs */
        .tab-btn {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #a0a0a0;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .tab-btn:hover {
            color: #e0e0e0;
            border-bottom-color: #575757;
        }
        .tab-btn.active {
            color: #27ae60;
            border-bottom-color: #27ae60;
        }
        .tab-content {
            display: none;
            height: calc(100vh - 350px);
            overflow-y: auto;
        }
        .tab-content.active {
            display: flex;
            flex-direction: column;
        }
        .resizable-options-section {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 550px);
            /*flex: 1;*/
            min-height: 0;
        }
        .table-container-scrollable,
        .table-container {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }
    </style>
</head>
<body class="symbol-page">
    <div class="app-container">
        <!-- Sidebar -->
        {{template "_navigation.html" .}}
        
        <!-- Main Content -->
        <div class="main-content">
            
            <!-- Stock Header Info -->
            <div class="stock-header">
                <div class="stock-info" style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                    <div>
                        <div class="stock-title">{{.Symbol}} - {{.CompanyName}}</div>
                    </div>
                    
                    {{$longValue := 0.0}}
                    {{range .LongPositionsList}}
                        {{if not .Closed}}
                            {{$longValue = add $longValue (mul .BuyPrice .Shares)}}
                        {{end}}
                    {{end}}
                    {{$putExposed := 0.0}}
                    {{range .OptionsList}}
                        {{if and (eq .Type "Put") (not .Closed)}}
                            {{$putExposed = add $putExposed (mul (mul .Strike .Contracts) 100)}}
                        {{end}}
                    {{end}}
                    
                    <!-- Summary Items -->
                    <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
                        <div style="display: flex; flex-direction: column; align-items: center; min-width: 85px;">
                            <div style="font-size: 16px; color: #a0a0a0;">Price</div>
                            <div id="current-price" style="font-size: 20px; color: #e0e0e0; font-weight: 700;">{{formatCurrencyWithDecimals .Price}}</div>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; min-width: 85px;">
                            <div style="font-size: 16px; color: #a0a0a0;">Div</div>
                            <div style="font-size: 20px; color: #e0e0e0; font-weight: 700;">{{formatCurrencyWithDecimals .Dividend}}</div>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; min-width: 85px;">
                            <div style="font-size: 16px; color: #a0a0a0;">Yield</div>
                            <div style="font-size: 20px; color: #e0e0e0; font-weight: 700;">{{printf "%.2f" .Yield}}%</div>
                        </div>
                        {{if .ExDividendDate}}
                        <div style="display: flex; flex-direction: column; align-items: center; min-width: 85px;">
                            <div style="font-size: 16px; color: #a0a0a0;">Ex-Div</div>
                            <div style="font-size: 20px; color: #e0e0e0; font-weight: 700;">{{.ExDividendDate.Format "01/02"}}</div>
                        </div>
                        {{end}}
                        {{if .HasPERatio}}
                        <div style="display: flex; flex-direction: column; align-items: center; min-width: 85px;">
                            <div style="font-size: 16px; color: #a0a0a0;">P/E</div>
                            <div style="font-size: 20px; color: #e0e0e0; font-weight: 700;">{{printf "%.2f" .PERatioValue}}</div>
                        </div>
                        {{end}}
                        <div style="display: flex; flex-direction: column; align-items: center; min-width: 110px;">
                            <div style="font-size: 16px; color: #a0a0a0;">Options Gains</div>
                            <div style="font-size: 20px; color: #4ade80; font-weight: 700;">{{formatCurrencyWithDecimals .OptionsGains}}</div>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; min-width: 95px;">
                            <div style="font-size: 16px; color: #a0a0a0;">Cap Gains</div>
                            <div style="font-size: 20px; color: #4ade80; font-weight: 700;">{{formatCurrencyWithDecimals .CapGains}}</div>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; min-width: 95px;">
                            <div style="font-size: 16px; color: #a0a0a0;">Dividends</div>
                            <div style="font-size: 20px; color: #4ade80; font-weight: 700;">{{formatCurrencyWithDecimals .Dividends}}</div>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; min-width: 105px;">
                            <div style="font-size: 16px; color: #a0a0a0;">Total Profits</div>
                            <div style="font-size: 20px; color: #4ade80; font-weight: 700;">{{formatCurrencyWithDecimals .TotalProfits}}</div>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; min-width: 105px;">
                            <div style="font-size: 16px; color: #a0a0a0;">Cash on Cash</div>
                            <div style="font-size: 20px; color: #4ade80; font-weight: 700;">{{.CashOnCash}}%</div>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; min-width: 100px;">
                            <div style="font-size: 16px; color: #a0a0a0;">Long Value</div>
                            <div style="font-size: 20px; color: #e0e0e0; font-weight: 700;">{{formatCurrency $longValue}}</div>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; min-width: 105px;">
                            <div style="font-size: 16px; color: #a0a0a0;">Put Exposed</div>
                            <div style="font-size: 20px; color: #e0e0e0; font-weight: 700;">{{formatCurrency $putExposed}}</div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="row-actions">
                        <button class="actions-toggle">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <div class="actions-menu">
                            <button id="editSymbolBtn">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button id="deleteSymbolBtn" class="delete-action">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Symbol Summary Panel -->
            <div class="content-section" style="margin-bottom: 20px;">
                <!-- Income Charts Grid -->
                <div style="display: flex; gap: 15px;">
                    <!-- Stacked Bar Chart -->
                    <div style="flex: 1; background: #2d2d2d; padding: 12px; border-radius: 8px; border: 1px solid #404040;">
                        <h3 style="color: #e0e0e0; margin-bottom: 8px; font-size: 15px;">Income Over Time</h3>
                        <div style="height: 270px; display: flex; align-items: center; justify-content: center;">
                            <canvas id="symbolStackedChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Pie Chart (15% bigger) -->
                    <div style="flex: 0.95; background: #282828; padding: 12px; border-radius: 8px; border: 1px solid #404040;">
                        <h3 style="color: #e0e0e0; margin-bottom: 8px; font-size: 15px;">Income by Type</h3>
                        <div style="height: 270px; display: flex; align-items: center; justify-content: center; padding: 15px;">
                            <div style="width: 100%; height: 100%; position: relative;">
                                <canvas id="symbolPieChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Options by Expiration Scatter Chart -->
                    <div style="flex: 1; background: #2d2d2d; padding: 12px; border-radius: 8px; border: 1px solid #404040;">
                        <h3 style="color: #e0e0e0; margin-bottom: 8px; font-size: 15px;">Options by Expiration</h3>
                        <div style="height: 270px; display: flex; align-items: center; justify-content: center;">
                            <canvas id="symbolExpirationChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Put Exposure Bar Chart -->
                    <div style="flex: 1; background: #2d2d2d; padding: 12px; border-radius: 8px; border: 1px solid #404040;">
                        <h3 style="color: #e0e0e0; margin-bottom: 8px; font-size: 15px;">Put Exposure</h3>
                        <div style="height: 270px; display: flex; align-items: center; justify-content: center;">
                            <canvas id="symbolPutExposureChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tabbed Trading Panel -->
            <div class="content-section resizable-options-section">
                <!-- Tab Navigation -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div class="tab-navigation" style="display: flex; gap: 10px;">
                        <button class="tab-btn active" data-tab="options">
                            Options{{if .OptionsList}} ({{len .OptionsList}}){{end}}
                        </button>
                        <button class="tab-btn" data-tab="positions">
                            Stock Positions{{if .LongPositionsList}} ({{len .LongPositionsList}}){{end}}
                        </button>
                        <button class="tab-btn" data-tab="dividends">
                            Dividends{{if .DividendsList}} ({{len .DividendsList}}){{end}}
                        </button>
                    </div>
                    <button id="addBtn" class="btn btn-primary">
                        <i class="fas fa-plus"></i>
                        Add
                    </button>
                </div>
                
                <!-- Hidden Add Buttons -->
                <button id="addOptionBtn" style="display: none;"></button>
                <button id="addLongPositionBtn" style="display: none;"></button>
                <button id="addDividendBtn" style="display: none;"></button>
                
                <!-- Options Tab Content -->
                <div class="tab-content active" id="options-tab">
                <div class="table-container-scrollable">
                    <table>
                        <thead>
                            <tr>
                                <th>Call/Put</th>
                                <th>Date Sold</th>
                                <th>Closed Date</th>
                                <th>Strike</th>
                                <th>OTM</th>
                                <th>Expiration</th>
                                <th>Remaining</th>
                                <th>DTE</th>
                                <th>DTC</th>
                                <th>Contracts</th>
                                <th>Premium</th>
                                <th>Exit Price</th>
                                <th>Commission</th>
                                <th>Total</th>
                                <th>% of Profit</th>
                                <th>% of Time</th>
                                <th>Multiplier</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{if .OptionsList}}
                                {{range .OptionsList}}
                                <tr>
                                    <td>
                                        <span class="{{if eq .Type "Put"}}put-badge{{else}}call-badge{{end}}">
                                            {{if eq .Type "Put"}}P{{else}}C{{end}}
                                        </span>
                                    </td>
                                    <td>{{.Opened.Format "01/02/2006"}}</td>
                                    <td>{{if .Closed}}{{.Closed.Format "01/02/2006"}}{{else}}-{{end}}</td>
                                    <td class="numeric-cell">{{printf "%.2f" .Strike}}</td>
                                    <td class="numeric-cell">{{printf "%.2f" (.CalculatePercentOTM $.Price)}}%</td>
                                    <td>{{.Expiration.Format "01/02/2006"}}</td>
                                    <td>
                                        {{if not .Closed}}
                                            <span class="{{if le .CalculateDaysRemaining 0}}dte-expired{{else if le .CalculateDaysRemaining 3}}dte-critical{{else if le .CalculateDaysRemaining 6}}dte-warning{{else if le .CalculateDaysRemaining 9}}dte-caution{{else if le .CalculateDaysRemaining 15}}dte-neutral{{else if le .CalculateDaysRemaining 21}}dte-safe{{else}}dte-healthy{{end}}">{{.CalculateDaysRemaining}} days</span>
                                        {{else}}
                                            - 
                                        {{end}}
                                    </td>
                                    <td class="numeric-cell">{{.CalculateDTE}}</td>
                                    <td class="numeric-cell">{{.CalculateDTC}}</td>
                                    <td class="numeric-cell">{{.Contracts}}</td>
                                    <td class="numeric-cell">{{printf "%.2f" .Premium}}</td>
                                    <td class="numeric-cell">{{if .ExitPrice}}${{printf "%.2f" (.GetExitPriceValue)}}{{else}}-{{end}}</td>
                                    <td class="numeric-cell">{{printf "%.2f" .Commission}}</td>
                                    <td class="numeric-cell">
                                        {{$totalProfit := .CalculateTotalProfit}}
                                        <span class="{{if lt $totalProfit 0.0}}negative{{else if gt $totalProfit 0.0}}positive{{else}}neutral-currency{{end}}">${{printf "%.2f" $totalProfit}}</span>
                                    </td>
                                    <td class="numeric-cell">
                                        {{if .Closed}}
                                            {{$percentProfit := .CalculatePercentOfProfit}}
                                            <span class="{{if lt $percentProfit 0.0}}negative{{else if gt $percentProfit 0.0}}positive{{else}}neutral-currency{{end}}">{{printf "%.2f" $percentProfit}}%</span>
                                        {{else}}
                                            -
                                        {{end}}
                                    </td>
                                    <td class="numeric-cell">
                                        {{if .Closed}}
                                            {{$percentProfit := .CalculatePercentOfProfit}}
                                            {{$percentTime := .CalculatePercentOfTime}}
                                            {{$multiplier := .CalculateMultiplier}}
                                            <span class="{{if ge $multiplier 2.0}}multiplier-excellent{{else if ge $multiplier 1.5}}multiplier-great{{else if ge $multiplier 1.0}}multiplier-good{{else if ge $multiplier 0.75}}multiplier-fair{{else if ge $multiplier 0.5}}multiplier-poor{{else if ge $multiplier 0.25}}multiplier-losing{{else if ge $multiplier 0.0}}multiplier-verybad{{else}}multiplier-terrible{{end}}">{{printf "%.2f" $percentTime}}%</span>
                                        {{else}}
                                            {{$percentTime := .CalculatePercentOfTime}}
                                            <span class="{{if lt $percentTime 0.0}}negative{{else if gt $percentTime 0.0}}positive{{else}}neutral-currency{{end}}">{{printf "%.2f" $percentTime}}%</span>
                                        {{end}}
                                    </td>
                                    <td class="numeric-cell">
                                        {{if .Closed}}
                                            {{$multiplier := .CalculateMultiplier}}
                                            <span class="{{if ge $multiplier 2.0}}multiplier-excellent{{else if ge $multiplier 1.5}}multiplier-great{{else if ge $multiplier 1.0}}multiplier-good{{else if ge $multiplier 0.75}}multiplier-fair{{else if ge $multiplier 0.5}}multiplier-poor{{else if ge $multiplier 0.25}}multiplier-losing{{else if ge $multiplier 0.0}}multiplier-verybad{{else}}multiplier-terrible{{end}}">{{printf "%.2f" $multiplier}}</span>
                                        {{else}}
                                            -
                                        {{end}}
                                    </td>
                                    <td>
                                        <div class="row-actions">
                                            <button class="actions-toggle">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <div class="actions-menu">
                                                <button class="edit-option-btn"
                                                        data-id="{{.ID}}"
                                                        data-symbol="{{.Symbol | html}}" 
                                                        data-type="{{.Type}}"
                                                        data-opened="{{.Opened.Format "2006-01-02"}}"
                                                        data-strike="{{.Strike}}"
                                                        data-expiration="{{.Expiration.Format "2006-01-02"}}"
                                                        data-premium="{{.Premium}}"
                                                        data-contracts="{{.Contracts}}"
                                                        data-closed="{{if .Closed}}{{.Closed.Format "2006-01-02"}}{{end}}"
                                                        data-exit-price="{{if .ExitPrice}}{{.GetExitPriceValue}}{{end}}"
                                                        data-commission="{{.Commission}}">
                                                    <i class="fas fa-edit"></i> Edit
                                                </button>
                                                <button class="delete-action delete-option-btn"
                                                        data-id="{{.ID}}"
                                                        data-symbol="{{.Symbol | html}}" 
                                                        data-type="{{.Type}}"
                                                        data-opened="{{.Opened.Format "2006-01-02"}}"
                                                        data-strike="{{.Strike}}"
                                                        data-expiration="{{.Expiration.Format "2006-01-02"}}"
                                                        data-premium="{{.Premium}}"
                                                        data-contracts="{{.Contracts}}">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {{end}}
                            {{else}}
                                <tr>
                                    <td colspan="18" style="text-align: center; color: #a0a0a0; padding: 20px;">
                                        No options trades recorded for {{.Symbol}}
                                    </td>
                                </tr>
                            {{end}}
                        </tbody>
                    </table>
                </div>
                </div>
                
                <!-- Stock Positions Tab Content -->
                <div class="tab-content" id="positions-tab">
                    <div class="table-container">
                        <table class="table-medium">
                            <thead>
                                <tr>
                                    <th>Purchased</th>
                                    <th>Closed Date</th>
                                    <th>Yield</th>
                                    <th>Shares</th>
                                    <th>Buy Price</th>
                                    <th>Exit Price</th>
                                    <th>Profit/Loss</th>
                                    <th>ROI</th>
                                    <th>Amount</th>
                                    <th>Total Invested</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{if .LongPositionsList}}
                                    {{range .LongPositionsList}}
                                    <tr>
                                        <td>{{.Opened.Format "1/2/2006"}}</td>
                                        <td>{{if .Closed}}{{.Closed.Format "1/2/2006"}}{{else}}-{{end}}</td>
                                        <td class="numeric-cell">{{printf "%.2f" (.CalculateYield $.Dividend)}}%</td>
                                        <td class="numeric-cell">{{.Shares}}</td>
                                        <td class="numeric-cell">{{formatCurrencyWithDecimals .BuyPrice}}</td>
                                        <td class="numeric-cell">{{if .ExitPrice}}{{formatCurrencyWithDecimals (.GetExitPriceValue)}}{{else}}-{{end}}</td>
                                        <td class="numeric-cell">
                                            {{$profitLoss := .CalculateProfitLoss $.Price}}
                                            <span class="{{if lt $profitLoss 0.0}}negative{{else if gt $profitLoss 0.0}}positive{{else}}neutral-currency{{end}}">{{formatCurrencyWithDecimals $profitLoss}}</span>
                                        </td>
                                        <td class="numeric-cell">
                                            {{$roi := .CalculateROI $.Price}}
                                            <span class="{{if lt $roi 0.0}}negative{{else if gt $roi 0.0}}positive{{else}}neutral-currency{{end}}">{{printf "%.2f" $roi}}%</span>
                                        </td>
                                        <td class="numeric-cell">{{formatCurrencyWithDecimals (.CalculateAmount)}}</td>
                                        <td class="numeric-cell">{{formatCurrencyWithDecimals (.CalculateTotalInvested)}}</td>
                                        <td>
                                            <div class="row-actions">
                                                <button class="actions-toggle">
                                                    <i class="fas fa-ellipsis-v"></i>
                                                </button>
                                                <div class="actions-menu">
                                                    <button class="edit-long-position-btn" data-id="{{.ID}}">
                                                        <i class="fas fa-edit"></i> Edit
                                                    </button>
                                                    <button class="delete-action delete-long-position-btn" data-id="{{.ID}}">
                                                        <i class="fas fa-trash"></i> Delete
                                                    </button>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {{end}}
                                {{else}}
                                    <tr>
                                        <td colspan="11" style="text-align: center; color: #a0a0a0; padding: 20px;">
                                            No stock positions recorded for {{.Symbol}}
                                        </td>
                                    </tr>
                                {{end}}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Dividends Tab Content -->
                <div class="tab-content" id="dividends-tab">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Received</th>
                                    <th>Amount</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{if .DividendsList}}
                                    {{range .DividendsList}}
                                    <tr>
                                        <td>{{.Received.Format "01/02/2006"}}</td>
                                        <td class="positive numeric-cell">{{formatCurrencyWithDecimals .Amount}}</td>
                                        <td>
                                            <div class="row-actions">
                                                <button class="actions-toggle">
                                                    <i class="fas fa-ellipsis-v"></i>
                                                </button>
                                                <div class="actions-menu">
                                                    <button class="edit-dividend-btn" 
                                                            data-id="{{.ID}}"
                                                            data-symbol="{{.Symbol | html}}" 
                                                            data-received="{{.Received.Format "2006-01-02"}}"
                                                            data-amount="{{.Amount}}">
                                                        <i class="fas fa-edit"></i> Edit
                                                    </button>
                                                    <button class="delete-action delete-dividend-btn"
                                                            data-id="{{.ID}}"
                                                            data-symbol="{{.Symbol | html}}" 
                                                            data-received="{{.Received.Format "2006-01-02"}}"
                                                            data-amount="{{.Amount}}">
                                                        <i class="fas fa-trash"></i> Delete
                                                    </button>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {{end}}
                                {{else}}
                                    <tr>
                                        <td colspan="3" style="text-align: center; color: #a0a0a0; padding: 20px;">
                                            No dividends recorded for {{.Symbol}}
                                        </td>
                                    </tr>
                                {{end}}
                            </tbody>
                            {{if .DividendsList}}
                            <tfoot>
                                <tr class="table-totals-row">
                                    <td>Total</td>
                                    <td class="positive">${{printf "%.2f" .DividendsTotal}}</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                            {{end}}
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Include Shared Symbol Modal -->
    {{template "_symbol_modal.html"}}

    <!-- Dividend Modal -->
    <div id="dividendModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="dividendModalTitle">Add Dividend</h2>
                <span class="close" id="closeDividendModal">&times;</span>
            </div>
            <form id="dividendForm">
                <div class="form-group">
                    <label for="dividendSymbolInput" class="form-label">Symbol</label>
                    <input type="text" id="dividendSymbolInput" class="form-input" readonly>
                </div>
                <div class="form-group">
                    <label for="dividendReceivedInput" class="form-label">Received Date *</label>
                    <input type="date" id="dividendReceivedInput" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="dividendAmountInput" class="form-label">Amount *</label>
                    <input type="number" id="dividendAmountInput" class="form-input" step="0.01" placeholder="0.00" required>
                </div>
                <div class="form-buttons">
                    <button type="submit" class="btn btn-primary" id="saveDividend">Save Dividend</button>
                    <button type="button" class="btn btn-secondary" id="cancelDividendModal">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Option Modal -->
    <div id="optionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="optionModalTitle">Add Option</h2>
                <span class="close" id="closeOptionModal">&times;</span>
            </div>
            <form id="optionForm">
                <div class="form-group">
                    <label for="optionQuickSymbolInput" class="form-label">Paste Option Symbol</label>
                    <input type="text" id="optionQuickSymbolInput" class="form-input" placeholder="e.g. AMD260320P190" autocomplete="off" spellcheck="false">
                    <span class="form-hint">Paste a compact option symbol to auto-fill fields below</span>
                </div>
                <div class="form-group">
                    <label for="optionSymbolInput" class="form-label">Symbol</label>
                    <input type="text" id="optionSymbolInput" class="form-input" readonly>
                </div>
                <div class="form-group">
                    <label for="optionTypeInput" class="form-label">Type *</label>
                    <select id="optionTypeInput" class="form-input" required>
                        <option value="">Select Option Type</option>
                        <option value="Put">Put</option>
                        <option value="Call">Call</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="optionOpenedInput" class="form-label">Date Sold *</label>
                        <input type="date" id="optionOpenedInput" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="optionStrikeInput" class="form-label">Strike Price *</label>
                        <input type="text" inputmode="decimal" id="optionStrikeInput" class="form-input" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="optionExpirationInput" class="form-label">Expiration Date *</label>
                        <input type="date" id="optionExpirationInput" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="optionPremiumInput" class="form-label">Premium *</label>
                        <input type="text" inputmode="decimal" id="optionPremiumInput" class="form-input" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="optionContractsInput" class="form-label">Contracts *</label>
                        <input type="number" id="optionContractsInput" class="form-input" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="optionCommissionInput" class="form-label">Commission</label>
                        <input type="text" inputmode="decimal" id="optionCommissionInput" class="form-input" value="0.00">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="optionClosedInput" class="form-label">Closed Date</label>
                        <input type="date" id="optionClosedInput" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="optionExitPriceInput" class="form-label">Exit Price</label>
                        <input type="text" inputmode="decimal" id="optionExitPriceInput" class="form-input">
                    </div>
                </div>
                <div class="form-buttons">
                    <button type="submit" class="btn btn-primary" id="saveOption">Save Option</button>
                    <button type="button" class="btn btn-secondary" id="cancelOptionModal">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Long Position Modal -->
    <div id="longPositionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="longPositionModalTitle">Add Long Position</h2>
                <span class="close" id="closeLongPositionModal">&times;</span>
            </div>
            <form id="longPositionForm">
                <div class="form-group">
                    <label for="longPositionSymbolInput" class="form-label">Symbol</label>
                    <input type="text" id="longPositionSymbolInput" class="form-input" readonly>
                </div>
                <div class="form-group">
                    <label for="longPositionOpenedInput" class="form-label">Purchase Date *</label>
                    <input type="date" id="longPositionOpenedInput" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="longPositionSharesInput" class="form-label">Shares *</label>
                    <input type="number" id="longPositionSharesInput" class="form-input" min="1" required>
                </div>
                <div class="form-group">
                    <label for="longPositionBuyPriceInput" class="form-label">Buy Price *</label>
                    <input type="number" id="longPositionBuyPriceInput" class="form-input" step="0.01" placeholder="0.00" required>
                </div>
                <div class="form-group">
                    <label for="longPositionClosedInput" class="form-label">Closed Date</label>
                    <input type="date" id="longPositionClosedInput" class="form-input">
                </div>
                <div class="form-group">
                    <label for="longPositionExitPriceInput" class="form-label">Exit Price</label>
                    <input type="number" id="longPositionExitPriceInput" class="form-input" step="0.01" placeholder="0.00">
                </div>
                <div class="form-buttons">
                    <button type="submit" class="btn btn-primary" id="saveLongPosition">Save Position</button>
                    <button type="button" class="btn btn-secondary" id="cancelLongPositionModal">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal jquery-modal fade">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalTitle">Confirm Action</h5>
                    <button type="button" class="modal-close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <p id="confirmModalMessage">Are you sure you want to proceed?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmModalConfirm">OK</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('Symbol view loaded for: {{.Symbol}}');
        
        // Modal helper functions
        function showConfirmModal(title, message, onConfirm) {
            $('#confirmModalTitle').text(title);
            $('#confirmModalMessage').html(message);
            $('#confirmModal').show();
            
            // Remove any existing event handlers
            $('#confirmModalConfirm').off('click');
            
            // Add new event handler
            $('#confirmModalConfirm').on('click', function() {
                $('#confirmModal').hide();
                if (onConfirm) onConfirm();
            });
        }
        
        // Modal dismiss handlers
        $(document).ready(function() {
            $('[data-dismiss="modal"]').on('click', function() {
                $(this).closest('.modal').hide();
            });
            
            $('.modal').on('click', function(e) {
                if (e.target === this) {
                    $(this).hide();
                }
            });
        });
        
        // Tab switching functionality
        let currentTab = 'options';
        
        function switchTab(tabName) {
            currentTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('active');
                }
            });
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Update Add button functionality
            const addBtn = document.getElementById('addBtn');
            addBtn.onclick = function() {
                if (tabName === 'options') {
                    document.getElementById('addOptionBtn').click();
                } else if (tabName === 'positions') {
                    document.getElementById('addLongPositionBtn').click();
                } else if (tabName === 'dividends') {
                    document.getElementById('addDividendBtn').click();
                }
            };
        }
        
        // Check if template rendering breaks here
        console.log('About to enter DOMContentLoaded...');
        
        console.log('Before DOMContentLoaded setup');
        
        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });
            
            // Set initial tab
            switchTab('options');
            console.log('INSIDE DOMContentLoaded - this should appear!');
            console.log('DOM is ready, initializing JavaScript...');
            
            // Get symbol safely from page title or data attribute
            const currentSymbol = document.title.split(' - ')[0];
            console.log('Current symbol:', currentSymbol);
            
            // Symbol Modal functionality (custom implementation for this page)
            // Mark that custom modal implementation is present
            window.symbolModalInitialized = true;
            
            const modal = document.getElementById('symbolModal');
        const editSymbolBtn = document.getElementById('editSymbolBtn');
        const newSymbolBtn = document.getElementById('newSymbolBtn');
        const closeModal = document.getElementById('closeModal');
        const cancelModal = document.getElementById('cancelModal');
        const symbolForm = document.getElementById('symbolForm');
        const modalTitle = document.getElementById('modalTitle');
        
        // Open modal for editing current symbol
        console.log('About to set up editSymbolBtn listener...');
        editSymbolBtn.addEventListener('click', function() {
            openModal(true, {
                symbol: currentSymbol,
                price: '{{printf "%.2f" .Price}}',
                dividend: '{{printf "%.2f" .Dividend}}',
                exDividendDate: {{if .ExDividendDate}}'{{.ExDividendDate.Format "2006-01-02"}}'{{else}}null{{end}},
                pe_ratio: {{if .PERatio}}'{{printf "%.2f" .PERatioValue}}'{{else}}null{{end}}
            });
        });
        console.log('EditSymbolBtn setup completed');
        
        // Open modal for new symbol
        newSymbolBtn.addEventListener('click', function() {
            openModal(false);
        });
        

        // Delete symbol button
        const deleteSymbolBtn = document.getElementById('deleteSymbolBtn');
        deleteSymbolBtn.addEventListener('click', function() {
            showConfirmModal(
                'Delete Symbol',
                `Are you sure you want to delete symbol <strong>${currentSymbol}</strong>?<br><br>This will remove all associated options, positions, and dividends.`,
                () => {
                    deleteSymbol(currentSymbol);
                }
            );
        });
        
        // Close modal
        closeModal.addEventListener('click', closeModalFunc);
        cancelModal.addEventListener('click', closeModalFunc);
        
        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target === modal) {
                closeModalFunc();
            }
        });
        
        function openModal(editMode = false, symbolData = null) {
            modalTitle.textContent = editMode ? 'Edit Symbol' : 'New Symbol';
            
            if (editMode && symbolData) {
                document.getElementById('symbolInput').value = symbolData.symbol;
                document.getElementById('priceInput').value = symbolData.price || '';
                document.getElementById('dividendInput').value = symbolData.dividend || '';
                document.getElementById('exDividendDateInput').value = symbolData.exDividendDate || '';
                document.getElementById('peRatioInput').value = symbolData.pe_ratio || '';
                document.getElementById('symbolInput').disabled = true;
            } else {
                symbolForm.reset();
                document.getElementById('symbolInput').disabled = false;
            }
            
            modal.style.display = 'block';
        }
        
        function closeModalFunc() {
            modal.style.display = 'none';
            symbolForm.reset();
        }
        
        // Handle form submission
        symbolForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const exDivDateValue = document.getElementById('exDividendDateInput').value;
            const symbolData = {
                symbol: document.getElementById('symbolInput').value.toUpperCase(),
                price: parseFloat(document.getElementById('priceInput').value) || 0,
                dividend: parseFloat(document.getElementById('dividendInput').value) || 0,
                ex_dividend_date: exDivDateValue || null,
                pe_ratio: parseFloat(document.getElementById('peRatioInput').value) || null
            };
            
            const url = `/api/symbols/${symbolData.symbol}`;
            
            fetch(url, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    price: symbolData.price,
                    dividend: symbolData.dividend,
                    ex_dividend_date: symbolData.ex_dividend_date,
                    pe_ratio: symbolData.pe_ratio
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Failed to save symbol');
            })
            .then(data => {
                console.log('Symbol saved successfully:', data);
                closeModalFunc();
                
                // Check if we're creating a new symbol or editing current one
                if (data.symbol === currentSymbol) {
                    // Editing current symbol - update display
                    const currentPriceElement = document.getElementById('current-price');
                    if (currentPriceElement) {
                        currentPriceElement.textContent = `$${data.price.toFixed(2)}`;
                    }
                } else {
                    // Creating new symbol - redirect to its page
                    window.location.href = `/symbol/${data.symbol}`;
                }
            })
            .catch(error => {
                console.error('Error saving symbol:', error);
                alert('Failed to save symbol. Please try again.');
            });
        });
        
        // Dividend Modal functionality
        const dividendModal = document.getElementById('dividendModal');
        const addDividendBtn = document.getElementById('addDividendBtn');
        const closeDividendModal = document.getElementById('closeDividendModal');
        const cancelDividendModal = document.getElementById('cancelDividendModal');
        const dividendForm = document.getElementById('dividendForm');
        const dividendModalTitle = document.getElementById('dividendModalTitle');
        
        let isEditingDividend = false;
        let originalDividendData = null;
        
        // Add dividend button
        addDividendBtn.addEventListener('click', function() {
            openDividendModal(false);
        });
        
        // Edit dividend buttons
        document.addEventListener('click', function(event) {
            if (event.target.closest('.edit-dividend-btn')) {
                const btn = event.target.closest('.edit-dividend-btn');
                const dividendData = {
                    symbol: btn.dataset.symbol,
                    received: btn.dataset.received,
                    amount: parseFloat(btn.dataset.amount)
                };
                openDividendModal(true, dividendData);
            }
        });
        
        // Delete dividend buttons
        document.addEventListener('click', function(event) {
            if (event.target.closest('.delete-dividend-btn')) {
                const btn = event.target.closest('.delete-dividend-btn');
                showConfirmModal(
                    'Delete Dividend',
                    `Are you sure you want to delete this dividend record?<br><br><strong>$${btn.dataset.amount}</strong> received on <strong>${btn.dataset.received}</strong>`,
                    () => {
                        deleteDividend(btn.dataset.id, btn.dataset.symbol, btn.dataset.received, btn.dataset.amount);
                    }
                );
            }
        });
        
        // Close dividend modal
        closeDividendModal.addEventListener('click', closeDividendModalFunc);
        cancelDividendModal.addEventListener('click', closeDividendModalFunc);
        
        // Close dividend modal when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target === dividendModal) {
                closeDividendModalFunc();
            }
        });
        
        function openDividendModal(editMode = false, dividendData = null) {
            isEditingDividend = editMode;
            dividendModalTitle.textContent = editMode ? 'Edit Dividend' : 'Add Dividend';
            
            document.getElementById('dividendSymbolInput').value = currentSymbol;
            
            if (editMode && dividendData) {
                originalDividendData = dividendData;
                document.getElementById('dividendReceivedInput').value = dividendData.received;
                document.getElementById('dividendAmountInput').value = dividendData.amount;
            } else {
                dividendForm.reset();
                document.getElementById('dividendSymbolInput').value = currentSymbol;
                originalDividendData = null;
            }
            
            dividendModal.style.display = 'block';
        }
        
        function closeDividendModalFunc() {
            dividendModal.style.display = 'none';
            dividendForm.reset();
            isEditingDividend = false;
            originalDividendData = null;
        }
        
        // Handle dividend form submission
        dividendForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const dividendData = {
                symbol: document.getElementById('dividendSymbolInput').value,
                received: document.getElementById('dividendReceivedInput').value,
                amount: parseFloat(document.getElementById('dividendAmountInput').value)
            };
            
            if (isEditingDividend) {
                updateDividend(originalDividendData, dividendData);
            } else {
                createDividend(dividendData);
            }
        });
        
        function createDividend(dividendData) {
            fetch('/api/dividends', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dividendData)
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Failed to create dividend');
            })
            .then(data => {
                console.log('Dividend created successfully:', data);
                closeDividendModalFunc();
                window.location.reload(); // Refresh to show new dividend
            })
            .catch(error => {
                console.error('Error creating dividend:', error);
                alert('Failed to create dividend. Please try again.');
            });
        }
        
        function updateDividend(originalData, newData) {
            // For update, we need to delete the old one and create a new one
            // since dividends use compound primary key (symbol + received + amount)
            fetch('/api/dividends', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    symbol: originalData.symbol,
                    received: originalData.received,
                    amount: originalData.amount
                })
            })
            .then(response => {
                if (response.ok) {
                    return createDividend(newData);
                }
                throw new Error('Failed to update dividend');
            })
            .catch(error => {
                console.error('Error updating dividend:', error);
                alert('Failed to update dividend. Please try again.');
            });
        }
        
        function deleteDividend(id, symbol, received, amount) {
            const deleteData = {
                id: parseInt(id),
                symbol: symbol,
                received: received,
                amount: parseFloat(amount)
            };
            console.log('Deleting dividend with data:', deleteData);
            
            fetch('/api/dividends', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(deleteData)
            })
            .then(response => {
                if (response.ok) {
                    console.log('Dividend deleted successfully');
                    window.location.reload(); // Refresh to show updated table
                } else {
                    throw new Error('Failed to delete dividend');
                }
            })
            .catch(error => {
                console.error('Error deleting dividend:', error);
                alert('Failed to delete dividend. Please try again.');
            });
        }

        // Apply dynamic color coding based on values
        function applyDynamicColors() {
            // Handle summary values
            const summaryValues = document.querySelectorAll('.summary-value');
            
            summaryValues.forEach(valueElement => {
                const text = valueElement.textContent.trim();
                
                // Extract numeric value from text (remove $, %, commas)
                let numericValue = parseFloat(text.replace(/[$,%]/g, '').replace(/,/g, ''));
                
                // Skip if we can't parse a number
                if (isNaN(numericValue)) {
                    return;
                }
                
                // Remove existing color classes
                valueElement.classList.remove('positive', 'negative');
                
                // Apply conservative coloring: only losses are red, profits are neutral
                if (numericValue < 0) {
                    valueElement.classList.add('negative');
                }
                // Note: Removed positive class application - profits stay neutral
            });
            
            // Handle Options table profit/loss coloring
            const optionsTableRows = document.querySelectorAll('.table-container-scrollable tbody tr');
            optionsTableRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                
                // Percent of Profit column (index 12, 0-based)
                if (cells[12]) {
                    const percentText = cells[12].textContent.trim();
                    const percentMatch = percentText.match(/^(-?\d+(?:\.\d+)?)%$/);
                    if (percentMatch) {
                        const percentValue = parseFloat(percentMatch[1]);
                        if (percentValue < 0) {
                            cells[12].innerHTML = '<span class="negative">' + percentText + '</span>';
                        } else {
                            cells[12].innerHTML = '<span>' + percentText + '</span>';
                        }
                    }
                }
                
                // Total Profit column (index 15, 0-based)
                if (cells[15]) {
                    const totalText = cells[15].textContent.trim();
                    const totalMatch = totalText.match(/^\$(-?\d+(?:\.\d+)?)$/);
                    if (totalMatch) {
                        const totalValue = parseFloat(totalMatch[1]);
                        if (totalValue < 0) {
                            cells[15].innerHTML = '<span class="negative">' + totalText + '</span>';
                        } else {
                            cells[15].innerHTML = '<span>' + totalText + '</span>';
                        }
                    }
                }
            });
            
            // Handle Stock Positions table profit/loss coloring
            const stockPositionsRows = document.querySelectorAll('.section-row .content-section:first-child table tbody tr');
            stockPositionsRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                
                // Profit/Loss column (index 6, 0-based)
                if (cells[6]) {
                    const profitText = cells[6].textContent.trim();
                    const profitMatch = profitText.match(/^\$(-?\d+(?:\.\d+)?)$/);
                    if (profitMatch) {
                        const profitValue = parseFloat(profitMatch[1]);
                        if (profitValue < 0) {
                            cells[6].innerHTML = '<span class="negative">' + profitText + '</span>';
                        } else {
                            cells[6].innerHTML = '<span>' + profitText + '</span>';
                        }
                    }
                }
                
                // ROI column (index 7, 0-based)
                if (cells[7]) {
                    const roiText = cells[7].textContent.trim();
                    const roiMatch = roiText.match(/^(-?\d+(?:\.\d+)?)%$/);
                    if (roiMatch) {
                        const roiValue = parseFloat(roiMatch[1]);
                        if (roiValue < 0) {
                            cells[7].innerHTML = '<span class="negative">' + roiText + '</span>';
                        } else {
                            cells[7].innerHTML = '<span>' + roiText + '</span>';
                        }
                    }
                }
            });
        }

        // Long Position Modal functionality
        const longPositionModal = document.getElementById('longPositionModal');
        const addLongPositionBtn = document.getElementById('addLongPositionBtn');
        const closeLongPositionModal = document.getElementById('closeLongPositionModal');
        const cancelLongPositionModal = document.getElementById('cancelLongPositionModal');
        const longPositionForm = document.getElementById('longPositionForm');
        const longPositionModalTitle = document.getElementById('longPositionModalTitle');
        
        let isEditingLongPosition = false;
        let originalLongPositionData = null;
        
        // Open long position modal for new position
        addLongPositionBtn.addEventListener('click', function() {
            console.log('Add Long Position button clicked');
            openLongPositionModal(false);
        });
        
        // Close long position modal
        closeLongPositionModal.addEventListener('click', closeLongPositionModalFunc);
        cancelLongPositionModal.addEventListener('click', closeLongPositionModalFunc);
        
        // Close long position modal when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target === longPositionModal) {
                closeLongPositionModalFunc();
            }
        });
        
        function openLongPositionModal(editMode = false, positionData = null) {
            console.log('openLongPositionModal called with editMode:', editMode, 'positionData:', positionData);
            isEditingLongPosition = editMode;
            longPositionModalTitle.textContent = editMode ? 'Edit Long Position' : 'Add Long Position';
            
            document.getElementById('longPositionSymbolInput').value = currentSymbol;
            
            if (editMode && positionData) {
                originalLongPositionData = positionData;
                document.getElementById('longPositionOpenedInput').value = positionData.opened;
                document.getElementById('longPositionSharesInput').value = positionData.shares;
                document.getElementById('longPositionBuyPriceInput').value = positionData.buy_price;
                document.getElementById('longPositionClosedInput').value = positionData.closed || '';
                document.getElementById('longPositionExitPriceInput').value = positionData.exit_price || '';
            } else {
                longPositionForm.reset();
                document.getElementById('longPositionSymbolInput').value = currentSymbol;
                // Set Purchase Date to today's date
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('longPositionOpenedInput').value = today;
                originalLongPositionData = null;
            }
            
            longPositionModal.style.display = 'block';
            console.log('Modal should now be visible');
        }
        
        function closeLongPositionModalFunc() {
            longPositionModal.style.display = 'none';
            longPositionForm.reset();
            isEditingLongPosition = false;
            originalLongPositionData = null;
        }
        
        // Handle long position form submission
        longPositionForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const positionData = {
                symbol: document.getElementById('longPositionSymbolInput').value,
                opened: document.getElementById('longPositionOpenedInput').value,
                shares: parseInt(document.getElementById('longPositionSharesInput').value),
                buy_price: parseFloat(document.getElementById('longPositionBuyPriceInput').value),
                closed: document.getElementById('longPositionClosedInput').value || null,
                exit_price: document.getElementById('longPositionExitPriceInput').value ? parseFloat(document.getElementById('longPositionExitPriceInput').value) : null
            };
            
            // Include ID for edit operations
            if (isEditingLongPosition && originalLongPositionData) {
                positionData.id = originalLongPositionData.id;
            }
            
            if (isEditingLongPosition) {
                updateLongPosition(originalLongPositionData, positionData);
            } else {
                createLongPosition(positionData);
            }
        });
        
        function createLongPosition(positionData) {
            fetch('/api/long-positions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(positionData)
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Failed to create long position');
            })
            .then(data => {
                console.log('Long position created successfully:', data);
                closeLongPositionModalFunc();
                window.location.reload(); // Refresh to show new position
            })
            .catch(error => {
                console.error('Error creating long position:', error);
                alert('Failed to create long position. Please try again.');
            });
        }
        
        function updateLongPosition(originalData, newData) {
            fetch('/api/long-positions', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newData)
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Failed to update long position');
            })
            .then(data => {
                console.log('Long position updated successfully:', data);
                closeLongPositionModalFunc();
                window.location.reload(); // Refresh to show updated position
            })
            .catch(error => {
                console.error('Error updating long position:', error);
                alert('Failed to update long position. Please try again.');
            });
        }
        
        function deleteLongPosition(positionData) {
            fetch('/api/long-positions', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(positionData)
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Failed to delete long position');
            })
            .then(data => {
                console.log('Long position deleted successfully:', data);
                window.location.reload(); // Refresh to remove deleted position
            })
            .catch(error => {
                console.error('Error deleting long position:', error);
                alert('Failed to delete long position. Please try again.');
            });
        }
        
        // Edit long position buttons
        document.addEventListener('click', function(event) {
            if (event.target.closest('.edit-long-position-btn')) {
                console.log('Edit button clicked');
                const btn = event.target.closest('.edit-long-position-btn');
                const row = btn.closest('tr');
                const cells = row.querySelectorAll('td');
                
                const positionData = {
                    id: parseInt(btn.dataset.id),
                    symbol: currentSymbol,
                    opened: cells[0].textContent.trim(),
                    closed: cells[1].textContent.trim() === '-' ? null : cells[1].textContent.trim(),
                    shares: parseInt(cells[3].textContent.trim()),
                    buy_price: parseFloat(cells[4].textContent.replace('$', '')),
                    exit_price: cells[5].textContent.trim() === '-' ? null : parseFloat(cells[5].textContent.replace('$', ''))
                };
                
                // Convert date format from MM/DD/YYYY to YYYY-MM-DD for input fields
                const convertDateFormat = (dateStr) => {
                    if (!dateStr || dateStr === '-') return '';
                    const [month, day, year] = dateStr.split('/');
                    return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                };
                
                positionData.opened = convertDateFormat(positionData.opened);
                positionData.closed = convertDateFormat(positionData.closed);
                
                openLongPositionModal(true, positionData);
            }
        });
        
        // Delete long position buttons
        document.addEventListener('click', function(event) {
            if (event.target.closest('.delete-long-position-btn')) {
                console.log('Delete button clicked');
                const btn = event.target.closest('.delete-long-position-btn');
                showConfirmModal(
                    'Delete Stock Position',
                    `Are you sure you want to delete this stock position?<br><br>This action cannot be undone.`,
                    () => {
                        deleteLongPosition({
                            id: parseInt(btn.dataset.id)
                        });
                    }
                );
            }
        });

        // Option Modal functionality
        const optionModal = document.getElementById('optionModal');
        const addOptionBtn = document.getElementById('addOptionBtn');
        const closeOptionModal = document.getElementById('closeOptionModal');
        const cancelOptionModal = document.getElementById('cancelOptionModal');
        const optionForm = document.getElementById('optionForm');
        const optionModalTitle = document.getElementById('optionModalTitle');
        
        let isEditingOption = false;
        let originalOptionData = null;
        
        // Add option button
        addOptionBtn.addEventListener('click', function() {
            openOptionModal(false);
        });
        
        // Edit option buttons
        document.addEventListener('click', function(event) {
            if (event.target.closest('.edit-option-btn')) {
                const btn = event.target.closest('.edit-option-btn');
                const optionData = {
                    id: parseInt(btn.dataset.id),
                    symbol: btn.dataset.symbol,
                    type: btn.dataset.type,
                    opened: btn.dataset.opened,
                    strike: parseFloat(btn.dataset.strike),
                    expiration: btn.dataset.expiration,
                    premium: parseFloat(btn.dataset.premium),
                    contracts: parseInt(btn.dataset.contracts),
                    closed: btn.dataset.closed || null,
                    exit_price: btn.dataset.exitPrice ? parseFloat(btn.dataset.exitPrice) : null,
                    commission: parseFloat(btn.dataset.commission) || 0.0
                };
                openOptionModal(true, optionData);
            }
        });
        
        // Delete option buttons
        document.addEventListener('click', function(event) {
            if (event.target.closest('.delete-option-btn')) {
                const btn = event.target.closest('.delete-option-btn');
                showConfirmModal(
                    'Delete Option Trade',
                    `Are you sure you want to delete this option trade?<br><br><strong>${btn.dataset.type}</strong> - Strike $${btn.dataset.strike} - ${btn.dataset.expiration}`,
                    () => {
                        deleteOption({
                            id: parseInt(btn.dataset.id),
                            symbol: btn.dataset.symbol,
                            type: btn.dataset.type,
                            opened: btn.dataset.opened,
                            strike: parseFloat(btn.dataset.strike),
                            expiration: btn.dataset.expiration,
                            premium: parseFloat(btn.dataset.premium),
                            contracts: parseInt(btn.dataset.contracts)
                        });
                    }
                );
            }
        });
        
        // Close option modal
        closeOptionModal.addEventListener('click', closeOptionModalFunc);
        cancelOptionModal.addEventListener('click', closeOptionModalFunc);
        
        // Close option modal when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target === optionModal) {
                closeOptionModalFunc();
            }
        });
        
        function openOptionModal(editMode = false, optionData = null) {
            isEditingOption = editMode;
            optionModalTitle.textContent = editMode ? 'Edit Option' : 'Add Option';
            
            document.getElementById('optionSymbolInput').value = currentSymbol;
            
            if (editMode && optionData) {
                originalOptionData = optionData;
                document.getElementById('optionTypeInput').value = optionData.type;
                document.getElementById('optionOpenedInput').value = optionData.opened;
                document.getElementById('optionClosedInput').value = optionData.closed || '';
                document.getElementById('optionStrikeInput').value = optionData.strike;
                document.getElementById('optionExpirationInput').value = optionData.expiration;
                document.getElementById('optionPremiumInput').value = optionData.premium;
                document.getElementById('optionContractsInput').value = optionData.contracts;
                document.getElementById('optionExitPriceInput').value = optionData.exit_price || '';
                document.getElementById('optionCommissionInput').value = optionData.commission;
            } else {
                optionForm.reset();
                document.getElementById('optionSymbolInput').value = currentSymbol;
                // Set Date Sold to today's date
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('optionOpenedInput').value = today;
                document.getElementById('optionCommissionInput').value = '0.65';
                originalOptionData = null;
            }
            
            optionModal.style.display = 'block';
        }
        
        function closeOptionModalFunc() {
            optionModal.style.display = 'none';
            optionForm.reset();
            isEditingOption = false;
            originalOptionData = null;
        }
        
        // Strip dollar signs from currency inputs as user types/pastes
        ['optionStrikeInput', 'optionPremiumInput', 'optionCommissionInput', 'optionExitPriceInput'].forEach(function(id) {
            document.getElementById(id).addEventListener('input', function() {
                const pos = this.selectionStart;
                const hadDollar = this.value.includes('$');
                this.value = this.value.replace(/\$/g, '');
                if (hadDollar) this.setSelectionRange(pos - 1, pos - 1);
            });
        });

        // Parse compact option symbol string (e.g. "AMD260320P190" or "-AMD260320P190")
        function parseOptionSymbol(input) {
            const str = input.replace(/^-/, '').trim().toUpperCase();
            // Format: SYMBOL(letters) + YYMMDD(6 digits) + P/C + STRIKE(digits, optional decimal)
            const match = str.match(/^([A-Z]+)(\d{2})(\d{2})(\d{2})([PC])(\d+(?:\.\d+)?)$/);
            if (!match) return null;
            const [, symbol, yy, mm, dd, typeChar, strikeStr] = match;
            return {
                symbol: symbol,
                expiration: `20${yy}-${mm}-${dd}`,
                type: typeChar === 'P' ? 'Put' : 'Call',
                strike: strikeStr
            };
        }

        document.getElementById('optionQuickSymbolInput').addEventListener('input', function() {
            const parsed = parseOptionSymbol(this.value);
            if (!parsed) return;
            document.getElementById('optionTypeInput').value = parsed.type;
            document.getElementById('optionExpirationInput').value = parsed.expiration;
            document.getElementById('optionStrikeInput').value = parsed.strike;
            this.value = '';
            document.getElementById('optionPremiumInput').focus();
        });

        // Handle option form submission
        optionForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const optionData = {
                symbol: document.getElementById('optionSymbolInput').value,
                type: document.getElementById('optionTypeInput').value,
                opened: document.getElementById('optionOpenedInput').value,
                closed: document.getElementById('optionClosedInput').value || null,
                strike: parseFloat(document.getElementById('optionStrikeInput').value),
                expiration: document.getElementById('optionExpirationInput').value,
                premium: parseFloat(document.getElementById('optionPremiumInput').value),
                contracts: parseInt(document.getElementById('optionContractsInput').value),
                exit_price: parseFloat(document.getElementById('optionExitPriceInput').value) || null,
                commission: parseFloat(document.getElementById('optionCommissionInput').value) || 0.0
            };
            
            if (isEditingOption) {
                updateOption(originalOptionData, optionData);
            } else {
                createOption(optionData);
            }
        });
        
        function createOption(optionData) {
            fetch('/api/options', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(optionData)
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Failed to create option');
            })
            .then(data => {
                console.log('Option created successfully:', data);
                closeOptionModalFunc();
                window.location.reload(); // Refresh to show new option
            })
            .catch(error => {
                console.error('Error creating option:', error);
                alert('Failed to create option. Please try again.');
            });
        }
        
        function updateOption(originalData, newData) {
            // Use PUT request with ID-based update system
            fetch('/api/options', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id: originalData.id,
                    symbol: newData.symbol,
                    type: newData.type,
                    opened: newData.opened,
                    closed: newData.closed || null,
                    strike: newData.strike,
                    expiration: newData.expiration,
                    premium: newData.premium,
                    contracts: newData.contracts,
                    exit_price: newData.exit_price || null,
                    commission: newData.commission
                })
            })
            .then(response => {
                if (response.ok) {
                    console.log('Option updated successfully');
                    window.location.reload(); // Refresh to show updated table
                } else {
                    throw new Error('Failed to update option');
                }
            })
            .catch(error => {
                console.error('Error updating option:', error);
                alert('Failed to update option. Please try again.');
            });
        }
        
        function deleteOption(optionData) {
            fetch('/api/options', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(optionData)
            })
            .then(response => {
                if (response.ok) {
                    console.log('Option deleted successfully');
                    window.location.reload(); // Refresh to show updated table
                } else {
                    throw new Error('Failed to delete option');
                }
            })
            .catch(error => {
                console.error('Error deleting option:', error);
                alert('Failed to delete option. Please try again.');
            });
        }

        function updateSymbolPrice(symbol) {
            const updateBtn = document.getElementById('updatePriceBtn');
            const originalText = updateBtn.innerHTML;
            
            // Disable button and show loading state
            updateBtn.disabled = true;
            updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
            
            fetch(`/api/symbols/${symbol}/update-price`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Price updated successfully for', symbol);
                    // Reload the page to show updated price
                    window.location.reload();
                } else {
                    throw new Error(data.error || 'Failed to update price');
                }
            })
            .catch(error => {
                console.error('Error updating price:', error);
                alert('Failed to update price: ' + error.message);
            })
            .finally(() => {
                // Restore button state
                updateBtn.disabled = false;
                updateBtn.innerHTML = originalText;
            });
        }

        function fetchSymbolDividends(symbol) {
            const fetchBtn = document.getElementById('fetchDividendsBtn');
            const originalText = fetchBtn.innerHTML;
            
            // Disable button and show loading state
            fetchBtn.disabled = true;
            fetchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Fetching...';
            
            fetch(`/api/symbols/${symbol}/fetch-dividends`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Dividends fetched successfully for', symbol);
                    const message = `Found ${data.count} dividend records for ${symbol}`;
                    
                    // Show dividend information in a more user-friendly way
                    if (data.dividends && data.dividends.length > 0) {
                        let dividendInfo = `<strong>Recent dividends for ${symbol}:</strong><br><br>`;
                        data.dividends.slice(0, 5).forEach(div => {
                            dividendInfo += ` $${div.cash_amount.toFixed(2)} - Ex-Date: ${div.ex_dividend_date}<br>`;
                        });
                        
                        showConfirmModal(
                            'Dividend Data Retrieved',
                            dividendInfo,
                            () => {
                                // Optional: User can choose to refresh page to see updated data
                                if (confirm('Would you like to refresh the page to see any updates?')) {
                                    window.location.reload();
                                }
                            }
                        );
                    } else {
                        alert(message + '\n\nNo recent dividends found.');
                    }
                } else {
                    throw new Error(data.error || 'Failed to fetch dividends');
                }
            })
            .catch(error => {
                console.error('Error fetching dividends:', error);
                alert('Failed to fetch dividends: ' + error.message);
            })
            .finally(() => {
                // Restore button state
                fetchBtn.disabled = false;
                fetchBtn.innerHTML = originalText;
            });
        }

        function deleteSymbol(symbol) {
            fetch(`/api/symbols/${symbol}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => {
                if (response.ok) {
                    console.log('Symbol deleted successfully');
                    // Redirect to dashboard since symbol page will no longer exist
                    window.location.href = '/';
                } else {
                    throw new Error('Failed to delete symbol');
                }
            })
            .catch(error => {
                console.error('Error deleting symbol:', error);
                alert('Failed to delete symbol. Please try again.');
            });
        }

        // Apply colors when page loads
        applyDynamicColors();
        
        // Test if we reach the end of JavaScript execution
        console.log('JavaScript fully loaded and executed');
        
        // Test if buttons exist and can be found
        const testAddBtn = document.getElementById('addLongPositionBtn');
        console.log('Add Long Position button found:', testAddBtn);
        if (testAddBtn) {
            console.log('Add button click listener attached');
        }
        
        // Test if edit buttons exist
        const editBtns = document.querySelectorAll('.edit-long-position-btn');
        console.log('Edit buttons found:', editBtns.length);
        
        // Test if delete buttons exist  
        const deleteBtns = document.querySelectorAll('.delete-long-position-btn');
        console.log('Delete buttons found:', deleteBtns.length);
        
        // Check for edit_option query parameter to auto-open option edit modal
        const urlParams = new URLSearchParams(window.location.search);
        const editOptionId = urlParams.get('edit_option');
        if (editOptionId) {
            console.log('Auto-opening option edit modal for ID:', editOptionId);
            // Wait for the page to fully load, then open the option modal
            setTimeout(() => {
                openOptionModalForEdit(editOptionId);
            }, 500);
        }
        
        // Function to open option modal for editing by option ID
        function openOptionModalForEdit(optionId) {
            console.log('Looking for option with ID:', optionId);
            
            // Find the edit button for this option ID
            const editBtn = document.querySelector(`[data-id="${optionId}"].edit-option-btn`);
            if (editBtn) {
                console.log('Found edit button, extracting option data');
                
                const optionData = {
                    id: parseInt(editBtn.dataset.id),
                    symbol: editBtn.dataset.symbol,
                    type: editBtn.dataset.type,
                    opened: editBtn.dataset.opened,
                    strike: parseFloat(editBtn.dataset.strike),
                    expiration: editBtn.dataset.expiration,
                    premium: parseFloat(editBtn.dataset.premium),
                    contracts: parseInt(editBtn.dataset.contracts),
                    closed: editBtn.dataset.closed || null,
                    exit_price: editBtn.dataset.exitPrice ? parseFloat(editBtn.dataset.exitPrice) : null,
                    commission: parseFloat(editBtn.dataset.commission) || 0.0
                };
                
                console.log('Opening option modal with data:', optionData);
                openOptionModal(true, optionData);
                
                // Clean up URL by removing the query parameter
                const newUrl = window.location.origin + window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
            } else {
                console.warn('Could not find option with ID:', optionId);
                // The option might not be visible in the current view, so let's try a different approach
                // by calling the API to fetch the option data directly
                fetchOptionAndOpenModal(optionId);
            }
        }
        
        // Helper function to format date strings for input fields
        function formatDateForInput(dateString) {
            if (!dateString) return null;
            
            try {
                // Parse the ISO date string and format it for input fields (YYYY-MM-DD)
                const date = new Date(dateString);
                return date.toISOString().split('T')[0];
            } catch (error) {
                console.error('Error formatting date:', dateString, error);
                return dateString; // Return original if parsing fails
            }
        }
        
        // Function to fetch option data via API and open modal
        function fetchOptionAndOpenModal(optionId) {
            console.log('Fetching option data via API for ID:', optionId);
            
            fetch(`/api/options/${optionId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(optionData => {
                    console.log('Fetched option data:', optionData);
                    
                    // Format the API response to match the format expected by openOptionModal
                    const formattedOptionData = {
                        id: optionData.id,
                        symbol: optionData.symbol,
                        type: optionData.type,
                        opened: formatDateForInput(optionData.opened),
                        strike: optionData.strike,
                        expiration: formatDateForInput(optionData.expiration),
                        premium: optionData.premium,
                        contracts: optionData.contracts,
                        closed: optionData.closed ? formatDateForInput(optionData.closed) : null,
                        exit_price: optionData.exit_price || null,
                        commission: optionData.commission || 0.0
                    };
                    
                    console.log('Formatted option data:', formattedOptionData);
                    openOptionModal(true, formattedOptionData);
                    
                    // Clean up URL by removing the query parameter
                    const newUrl = window.location.origin + window.location.pathname;
                    window.history.replaceState({}, document.title, newUrl);
                })
                .catch(error => {
                    console.error('Failed to fetch option data:', error);
                    alert('Could not load the option for editing. The option may have been deleted or you may not have permission to view it.');
                    
                    // Clean up URL even if there was an error
                    const newUrl = window.location.origin + window.location.pathname;
                    window.history.replaceState({}, document.title, newUrl);
                });
        }
        
        }); // End of DOMContentLoaded
    </script>
    <script>
        // Symbol summary panel charts
        $(document).ready(function() {
            // Calculate income by month for this symbol
            const monthlyPuts = {};
            const monthlyCalls = {};
            const monthlyCapGains = {};
            const monthlyDividends = {};
            const monthlyTotal = {};
            
            // Process options data
            {{range .OptionsList}}
                {
                    const optionMonth = '{{.Opened.Format "2006-01"}}';
                    const optionProfit = {{.CalculateTotalProfit}};
                    {{if eq .Type "Put"}}
                        monthlyPuts[optionMonth] = (monthlyPuts[optionMonth] || 0) + optionProfit;
                    {{else}}
                        monthlyCalls[optionMonth] = (monthlyCalls[optionMonth] || 0) + optionProfit;
                    {{end}}
                    monthlyTotal[optionMonth] = (monthlyTotal[optionMonth] || 0) + optionProfit;
                }
            {{end}}
            
            // Process long positions for cap gains
            {{range .LongPositionsList}}
                {{if .Closed}}
                    {{if .ExitPrice}}
                        {
                            const positionMonth = '{{.Closed.Format "2006-01"}}';
                            const positionProfit = {{.CalculateProfitLoss .ExitPrice}};
                            monthlyCapGains[positionMonth] = (monthlyCapGains[positionMonth] || 0) + positionProfit;
                            monthlyTotal[positionMonth] = (monthlyTotal[positionMonth] || 0) + positionProfit;
                        }
                    {{end}}
                {{end}}
            {{end}}
            
            // Process dividends
            {{range .DividendsList}}
                {
                    const dividendMonth = '{{.Received.Format "2006-01"}}';
                    monthlyDividends[dividendMonth] = (monthlyDividends[dividendMonth] || 0) + {{.Amount}};
                    monthlyTotal[dividendMonth] = (monthlyTotal[dividendMonth] || 0) + {{.Amount}};
                }
            {{end}}
            
            // Generate last 12 months
            const months = [];
            for (let i = 11; i >= 0; i--) {
                months.push(moment().subtract(i, 'months').format('YYYY-MM'));
            }
            const labels = months.map(m => moment(m + '-01').format('MMM YYYY'));
            
            // Prepare data for stacked bar chart
            const putsData = months.map(m => monthlyPuts[m] || 0);
            const callsData = months.map(m => monthlyCalls[m] || 0);
            const capGainsData = months.map(m => monthlyCapGains[m] || 0);
            const dividendsData = months.map(m => monthlyDividends[m] || 0);
            
            // Calculate cumulative data for line chart
            const cumulativeData = [];
            let runningTotal = 0;
            for (let i = 0; i < months.length; i++) {
                runningTotal += (putsData[i] + callsData[i] + capGainsData[i] + dividendsData[i]);
                cumulativeData.push(runningTotal);
            }
            
            // Calculate totals for pie chart
            const totalPuts = putsData.reduce((sum, val) => sum + val, 0);
            const totalCalls = callsData.reduce((sum, val) => sum + val, 0);
            const totalCapGains = capGainsData.reduce((sum, val) => sum + val, 0);
            const totalDividends = dividendsData.reduce((sum, val) => sum + val, 0);
            
            // Create stacked bar chart
            const stackedCtx = document.getElementById('symbolStackedChart').getContext('2d');
            new Chart(stackedCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            type: 'line',
                            label: 'Cumulative',
                            data: cumulativeData,
                            borderColor: '#FFD700',
                            backgroundColor: 'rgba(255, 215, 0, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.2,
                            yAxisID: 'y1',
                            order: 1
                        },
                        {
                            type: 'bar',
                            label: 'Puts',
                            data: putsData,
                            backgroundColor: '#3498db',
                            borderColor: '#3498db',
                            borderWidth: 1,
                            stack: 'stack0',
                            yAxisID: 'y',
                            order: 2
                        },
                        {
                            type: 'bar',
                            label: 'Calls',
                            data: callsData,
                            backgroundColor: '#e67e22',
                            borderColor: '#e67e22',
                            borderWidth: 1,
                            stack: 'stack0',
                            yAxisID: 'y',
                            order: 2
                        },
                        {
                            type: 'bar',
                            label: 'Capital Gains',
                            data: capGainsData,
                            backgroundColor: '#2ecc71',
                            borderColor: '#2ecc71',
                            borderWidth: 1,
                            stack: 'stack0',
                            yAxisID: 'y',
                            order: 2
                        },
                        {
                            type: 'bar',
                            label: 'Dividends',
                            data: dividendsData,
                            backgroundColor: '#f1c40f',
                            borderColor: '#f1c40f',
                            borderWidth: 1,
                            stack: 'stack0',
                            yAxisID: 'y',
                            order: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#e0e0e0',
                                font: { size: 12 },
                                padding: 10,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    return label + ': $' + context.parsed.y.toLocaleString();
                                },
                                footer: function(tooltipItems) {
                                    let total = 0;
                                    tooltipItems.forEach(item => {
                                        total += item.parsed.y;
                                    });
                                    return 'Total: $' + total.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            ticks: { color: '#a0a0a0' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            stacked: true,
                            type: 'linear',
                            display: true,
                            position: 'left',
                            ticks: {
                                color: '#a0a0a0',
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            ticks: {
                                color: '#FFD700',
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
            
            // Create donut chart for total income by type
            const pieCtx = document.getElementById('symbolPieChart').getContext('2d');
            
            // Plugin to draw text in center of donut
            const centerTextPlugin = {
                id: 'centerText',
                afterDatasetsDraw: function(chart) {
                    const ctx = chart.ctx;
                    const chartArea = chart.chartArea;
                    const centerX = (chartArea.left + chartArea.right) / 2;
                    const centerY = (chartArea.top + chartArea.bottom) / 2;
                    
                    const total = chart.data.datasets[0].data.reduce((sum, val) => sum + val, 0);
                    
                    ctx.save();
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    
                    // Draw "Total" label
                    ctx.font = 'bold 14px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
                    ctx.fillStyle = '#a0a0a0';
                    ctx.fillText('Total', centerX, centerY - 12);
                    
                    // Draw total value
                    ctx.font = 'bold 18px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
                    ctx.fillStyle = '#e0e0e0';
                    ctx.fillText('$' + total.toLocaleString(), centerX, centerY + 12);
                    
                    ctx.restore();
                }
            };
            
            new Chart(pieCtx, {
                plugins: [ChartDataLabels, centerTextPlugin],
                type: 'doughnut',
                data: {
                    labels: ['Puts', 'Calls', 'Capital Gains', 'Dividends'],
                    datasets: [{
                        data: [totalPuts, totalCalls, totalCapGains, totalDividends],
                        backgroundColor: [
                            '#3498db',
                            '#e67e22',
                            '#2ecc71',
                            '#f1c40f'
                        ],
                        borderColor: [
                            '#3498db',
                            '#e67e22',
                            '#2ecc71',
                            '#f1c40f'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            left: 10,
                            right: 10,
                            top: 10,
                            bottom: 10
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'right',
                            align: 'center',
                            labels: {
                                color: '#e0e0e0',
                                font: { size: 12 },
                                padding: 12,
                                usePointStyle: true,
                                boxWidth: 12,
                                boxHeight: 12
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return label + ': $' + value.toLocaleString() + ' (' + percentage + '%)';
                                }
                            }
                        },
                        datalabels: {
                            display: true,
                            color: '#ffffff',
                            font: {
                                size: 12,
                                weight: 'bold'
                            },
                            formatter: function(value, context) {
                                const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                if (total === 0 || value === 0) return '';
                                const percentage = ((value / total) * 100).toFixed(1);
                                return '$' + (value / 1000).toFixed(1) + 'K\n' + percentage + '%';
                            },
                            anchor: 'center',
                            align: 'center',
                            offset: 0
                        }
                    }
                }
            });
            
            // Create Options by Expiration scatter chart for this symbol
            const symbolExpirationScatterData = [];
            
            {{range .OptionsList}}
                {
                    const expirationDate = new Date('{{.Expiration.Format "2006-01-02"}}');
                    const totalProfit = {{.CalculateTotalProfit}};
                    const strike = {{.Strike}};
                    const contracts = {{.Contracts}};
                    const type = '{{.Type}}';
                    const isClosed = {{if .Closed}}true{{else}}false{{end}};
                    const nominalValue = strike * contracts * 100;
                    const riskScaledValue = type === 'Put' ? nominalValue * 1.5 : nominalValue;
                    
                    // Scale radius from nominal value
                    const minNominal = 1000;
                    const maxNominal = 50000;
                    const minRadius = 4;
                    const maxRadius = 20;
                    const scaledRadius = Math.max(minRadius, Math.min(maxRadius, 
                        minRadius + (riskScaledValue - minNominal) * (maxRadius - minRadius) / (maxNominal - minNominal)
                    ));
                    
                    symbolExpirationScatterData.push({
                        x: expirationDate,
                        y: totalProfit,
                        r: scaledRadius,
                        symbol: '{{.Symbol}}',
                        type: type,
                        strike: strike,
                        contracts: contracts,
                        nominalValue: nominalValue,
                        riskScaledValue: riskScaledValue,
                        isClosed: isClosed
                    });
                }
            {{end}}
            
            // Only create chart if we have data
            if (symbolExpirationScatterData.length === 0) {
                const canvas = document.getElementById('symbolExpirationChart');
                const parent = canvas.parentElement;
                parent.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #a0a0a0; font-size: 14px;">No options</div>';
            } else {
            
            // Create scatter chart
            const scatterCtx = document.getElementById('symbolExpirationChart').getContext('2d');
            new Chart(scatterCtx, {
                type: 'bubble',
                data: {
                    datasets: [{
                        label: 'Options',
                        data: symbolExpirationScatterData,
                        backgroundColor: function(ctx) {
                            const point = symbolExpirationScatterData[ctx.dataIndex];
                            if (!point) return '#3498db';
                            
                            let color;
                            if (point.y < 0) {
                                // Negative profit - blend with red
                                color = point.type === 'Put' ? '#8b4789' : '#8b6347';
                            } else {
                                // Positive profit - normal colors
                                color = point.type === 'Put' ? '#3498db' : '#27ae60';
                            }
                            
                            return point.isClosed ? color + '80' : color;
                        },
                        borderColor: function(ctx) {
                            const point = symbolExpirationScatterData[ctx.dataIndex];
                            if (!point) return '#3498db';
                            
                            if (point.y < 0) {
                                // Negative profit - blend with red
                                return point.type === 'Put' ? '#8b4789' : '#8b6347';
                            } else {
                                // Positive profit - normal colors
                                return point.type === 'Put' ? '#3498db' : '#27ae60';
                            }
                        },
                        borderWidth: function(ctx) {
                            const point = symbolExpirationScatterData[ctx.dataIndex];
                            return point && point.isClosed ? 1 : 2;
                        },
                        pointRadius: function(ctx) {
                            const point = symbolExpirationScatterData[ctx.dataIndex];
                            return point ? point.r : 8;
                        },
                        pointHoverRadius: function(ctx) {
                            const point = symbolExpirationScatterData[ctx.dataIndex];
                            return point ? point.r + 4 : 12;
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const point = symbolExpirationScatterData[context[0].dataIndex];
                                    return point.symbol + ' ' + point.type + ' $' + point.strike;
                                },
                                label: function(context) {
                                    const point = symbolExpirationScatterData[context.dataIndex];
                                    return [
                                        'Status: ' + (point.isClosed ? 'Closed' : 'Open'),
                                        'Contracts: ' + point.contracts,
                                        'Nominal: $' + point.nominalValue.toLocaleString(),
                                        'Profit: $' + point.y.toLocaleString()
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                displayFormats: {
                                    day: 'MM/dd'
                                }
                            },
                            ticks: { 
                                color: '#a0a0a0',
                                autoSkip: false,
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#a0a0a0',
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
            } // End of scatter chart conditional
            
            // Create Put Exposure Over Time chart - historical + 365 day forward view
            // Build a timeline of put exposure: each day shows total exposure from all active puts on that day
            
            // Collect all put option data with opened and expiration dates
            const putOptions = [];
            let latestExpiration = null;
            let earliestOpened = null;
            
            {{range .OptionsList}}
                {{if eq .Type "Put"}}
                    {
                        const opened = new Date('{{.Opened.Format "2006-01-02"}}');
                        const expiration = new Date('{{.Expiration.Format "2006-01-02"}}');
                        const closed = {{if .Closed}}new Date('{{.Closed.Format "2006-01-02"}}'){{else}}null{{end}};
                        const exposure = {{.Strike}} * {{.Contracts}} * 100;
                        const premium = {{.Premium}} * {{.Contracts}} * 100;
                        const commission = parseFloat('{{.Commission}}') || 0;
                        const exitPrice = {{if .ExitPrice}}{{.GetExitPriceValue}} * {{.Contracts}} * 100{{else}}0{{end}};
                        const profit = premium - commission - exitPrice;
                        
                        console.log('Put option:', {
                            opened: '{{.Opened.Format "2006-01-02"}}',
                            expiration: '{{.Expiration.Format "2006-01-02"}}',
                            premium: premium,
                            commission: commission,
                            exitPrice: exitPrice,
                            profit: profit
                        });
                        
                        putOptions.push({
                            opened: opened,
                            expiration: expiration,
                            closed: closed,
                            exposure: exposure,
                            premium: premium,
                            commission: commission,
                            profit: profit
                        });
                        
                        // Track latest expiration from all puts (open or closed)
                        if (!latestExpiration || expiration > latestExpiration) {
                            latestExpiration = expiration;
                        }
                        
                        // Track earliest opened date from all puts
                        if (!earliestOpened || opened < earliestOpened) {
                            earliestOpened = opened;
                        }
                    }
                {{end}}
            {{end}}
            
            // Determine date range: from earliest opened to latest expiration (or 365 days if no puts)
            let startDate, endDate;
            
            if (latestExpiration && earliestOpened) {
                // Show from earliest opened to latest expiration
                startDate = new Date(earliestOpened);
                endDate = new Date(latestExpiration);
            } else {
                // No puts - show last 365 days
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                endDate = new Date(today);
                startDate = new Date(today);
                startDate.setDate(startDate.getDate() - 365);
            }
            
            // Collect long position data for the same date range
            const longPositions = [];
            
            {{range .LongPositionsList}}
                {
                    const opened = new Date('{{.Opened.Format "2006-01-02"}}');
                    const closed = {{if .Closed}}new Date('{{.Closed.Format "2006-01-02"}}'){{else}}null{{end}};
                    const value = {{.BuyPrice}} * {{.Shares}};
                    
                    longPositions.push({
                        opened: opened,
                        closed: closed,
                        value: value
                    });
                }
            {{end}}
            
            // Calculate exposure and long value for each day
            const exposureByDate = {};
            const longValueByDate = {};
            let currentDate = new Date(startDate);
            
            console.log('Total put options:', putOptions.length);
            console.log('Total long positions:', longPositions.length);
            console.log('Date range:', startDate, 'to', endDate);
            
            while (currentDate <= endDate) {
                const dateStr = currentDate.toISOString().split('T')[0];
                let dailyExposure = 0;
                let dailyLongValue = 0;
                
                // Sum up exposure from all puts that are active on this date
                putOptions.forEach(put => {
                    const isActive = currentDate >= put.opened && currentDate <= put.expiration &&
                                   (!put.closed || currentDate < put.closed);
                    if (isActive) {
                        dailyExposure += put.exposure;
                    }
                });
                
                // Sum up long value from all positions that are active on this date
                longPositions.forEach(position => {
                    const isActive = currentDate >= position.opened &&
                                   (!position.closed || currentDate < position.closed);
                    if (isActive) {
                        dailyLongValue += position.value;
                    }
                });
                
                exposureByDate[dateStr] = dailyExposure;
                longValueByDate[dateStr] = dailyLongValue;
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            console.log('Sample data points:');
            console.log('Exposure:', Object.entries(exposureByDate).slice(0, 5));
            console.log('Long Value:', Object.entries(longValueByDate).slice(0, 5));
            
            // Sample weekly data points for cleaner chart (every 7 days)
            const weeklyLabels = [];
            const weeklyExposureData = [];
            const weeklyLongValueData = [];
            currentDate = new Date(startDate);
            
            while (currentDate <= endDate) {
                const dateStr = currentDate.toISOString().split('T')[0];
                weeklyLabels.push(dateStr);
                weeklyExposureData.push(exposureByDate[dateStr] || 0);
                weeklyLongValueData.push(longValueByDate[dateStr] || 0);
                currentDate.setDate(currentDate.getDate() + 7);
            }
            
            // Only create chart if we have puts or long positions
            if (putOptions.length === 0 && longPositions.length === 0) {
                const canvas = document.getElementById('symbolPutExposureChart');
                if (canvas) {
                    const parent = canvas.parentElement;
                    parent.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #a0a0a0; font-size: 14px;">No data</div>';
                }
            } else {
            
            // Create combination chart: bars for put exposure vs long value
            const putExposureCtx = document.getElementById('symbolPutExposureChart').getContext('2d');
            
            // Plugin to draw vertical line at today
            const todayLinePlugin = {
                id: 'todayLine',
                afterDatasetsDraw: function(chart) {
                    if (todayIndex >= 0 && todayIndex < chart.data.labels.length) {
                        const ctx = chart.ctx;
                        const xAxis = chart.scales.x;
                        const yAxis = chart.scales.y;
                        
                        const x = xAxis.getPixelForValue(todayIndex);
                        const topY = yAxis.top;
                        const bottomY = yAxis.bottom;
                        
                        ctx.save();
                        ctx.beginPath();
                        ctx.moveTo(x, topY);
                        ctx.lineTo(x, bottomY);
                        ctx.lineWidth = 2;
                        ctx.strokeStyle = '#e74c3c';
                        ctx.stroke();
                        ctx.restore();
                    }
                }
            };
            
            new Chart(putExposureCtx, {
                type: 'bar',
                plugins: [ChartDataLabels],
                data: {
                    labels: weeklyLabels.map(label => {
                        const date = new Date(label);
                        return (date.getMonth() + 1).toString().padStart(2, '0') + '/' + date.getDate().toString().padStart(2, '0');
                    }),
                    datasets: [
                        {
                            label: 'Put Exposure',
                            data: weeklyExposureData,
                            backgroundColor: 'rgba(52, 152, 219, 0.8)',
                            borderColor: '#3498db',
                            borderWidth: 1
                        },
                        {
                            label: 'Long Value',
                            data: weeklyLongValueData,
                            backgroundColor: 'rgba(39, 174, 96, 0.8)',
                            borderColor: '#27ae60',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#e0e0e0',
                                font: { size: 11 },
                                padding: 8,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += '$' + context.parsed.y.toLocaleString();
                                    return label;
                                }
                            }
                        },
                        datalabels: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            stacked: false,
                            ticks: {
                                color: '#a0a0a0',
                                font: { size: 10 },
                                maxRotation: 45,
                                minRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: 12
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            stacked: false,
                            type: 'linear',
                            position: 'left',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Value',
                                color: '#a0a0a0',
                                font: { size: 11 }
                            },
                            ticks: {
                                color: '#a0a0a0',
                                font: { size: 10 },
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'K';
                                }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
            } // End of put exposure chart conditional
        
        });
    </script>
    <script src="/static/js/navigation.js"></script>
    <script src="/static/js/symbol-modal.js"></script>
    <script src="/static/js/table-sort.js"></script>
    <script src="/static/js/row-actions.js"></script>
</body>
</html>